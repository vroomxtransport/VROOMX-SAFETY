---
phase: 07-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/Dashboard.jsx
autonomous: true

must_haves:
  truths:
    - "User sees last sync time in Dashboard header"
    - "User can click Sync Now button to trigger immediate refresh"
    - "Toast notification appears when sync completes with new violations count"
    - "Sync button is disabled and shows spinner while syncing"
  artifacts:
    - path: "frontend/src/pages/Dashboard.jsx"
      provides: "Sync status indicator with refresh button"
      contains: "fmcsaAPI.getSyncStatus"
  key_links:
    - from: "frontend/src/pages/Dashboard.jsx"
      to: "/api/fmcsa/sync-status"
      via: "fmcsaAPI.getSyncStatus on mount"
      pattern: "fmcsaAPI\\.getSyncStatus"
    - from: "frontend/src/pages/Dashboard.jsx"
      to: "/api/fmcsa/sync-violations"
      via: "fmcsaAPI.syncViolations on button click"
      pattern: "fmcsaAPI\\.syncViolations"
---

<objective>
Add sync status visibility and manual sync trigger to the Dashboard header.

Purpose: Users need to know when FMCSA data was last synced and be able to manually trigger a refresh when needed. This completes the sync visibility requirement (UI-01, UI-02, UI-04).

Output: Dashboard displays "Last synced: X ago" with a Sync Now button that triggers immediate refresh and shows toast notification on completion.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish/07-RESEARCH.md

# Key reference files
@frontend/src/pages/Dashboard.jsx
@frontend/src/pages/Integrations.jsx (formatLastSync pattern at line 121)
@frontend/src/pages/Compliance.jsx (getTimeSinceSync pattern at line 233)
@frontend/src/utils/api.js (fmcsaAPI at line 348-360)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sync status state and data fetching</name>
  <files>frontend/src/pages/Dashboard.jsx</files>
  <action>
Add sync status functionality to Dashboard.jsx:

1. Import fmcsaAPI at top: `import { fmcsaAPI } from '../utils/api';` (add to existing imports)

2. Add state variables after existing state declarations (~line 29):
```javascript
const [syncStatus, setSyncStatus] = useState(null);
const [syncing, setSyncing] = useState(false);
```

3. Add formatLastSync helper function (copy pattern from Integrations.jsx:121-134):
```javascript
const formatLastSync = (date) => {
  if (!date) return 'Never synced';
  const d = new Date(date);
  const now = new Date();
  const diff = now - d;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes} min ago`;
  if (hours < 24) return `${hours}h ago`;
  return `${days}d ago`;
};
```

4. Add isDataStale check:
```javascript
const isDataStale = syncStatus?.lastSync &&
  (Date.now() - new Date(syncStatus.lastSync).getTime()) > 6 * 60 * 60 * 1000;
```

5. In fetchDashboard function, add sync status fetch to the Promise.all array:
```javascript
fmcsaAPI.getSyncStatus().catch(() => null)
```
Then set the result:
```javascript
if (syncStatusRes?.data) {
  setSyncStatus(syncStatusRes.data);
}
```
  </action>
  <verify>
File compiles without errors:
```bash
cd frontend && npm run build 2>&1 | head -20
```
  </verify>
  <done>Dashboard fetches and stores sync status on mount</done>
</task>

<task type="auto">
  <name>Task 2: Add sync status indicator and Sync Now button to header</name>
  <files>frontend/src/pages/Dashboard.jsx</files>
  <action>
Add sync status UI and manual sync functionality:

1. Add handleSyncNow function after handleRefreshFMCSA (~line 95):
```javascript
// Handle manual FMCSA sync
const handleSyncNow = async () => {
  setSyncing(true);
  try {
    const response = await fmcsaAPI.syncViolations(true);

    // Refresh sync status
    const statusRes = await fmcsaAPI.getSyncStatus();
    if (statusRes?.data) {
      setSyncStatus(statusRes.data);
    }

    // Show toast with violation count
    const imported = response.data?.violations?.created || 0;
    if (imported > 0) {
      toast.success(`Synced ${imported} new violation${imported !== 1 ? 's' : ''} from FMCSA`);
    } else {
      toast.success('FMCSA sync complete - no new violations');
    }

    // Also refresh dashboard data
    await fetchDashboard();
  } catch (err) {
    toast.error(err.response?.data?.message || 'Failed to sync FMCSA data');
  } finally {
    setSyncing(false);
  }
};
```

2. Import toast at top if not already imported: `import toast from 'react-hot-toast';`

3. In the Welcome Header section (after line 236 "Here's your compliance overview"), add a sync status indicator in the header area. Find the div with "flex items-center gap-3" (~line 237) and add BEFORE the Generate Report link:

```jsx
{/* Sync Status Indicator */}
<div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-zinc-100 dark:bg-zinc-800/50 border border-zinc-200 dark:border-zinc-700">
  <FiClock className={`w-4 h-4 ${isDataStale ? 'text-yellow-500' : 'text-zinc-400 dark:text-zinc-500'}`} />
  <span className={`text-sm ${isDataStale ? 'text-yellow-600 dark:text-yellow-400' : 'text-zinc-600 dark:text-zinc-400'}`}>
    {formatLastSync(syncStatus?.lastSync)}
  </span>
  <button
    onClick={handleSyncNow}
    disabled={syncing}
    className="p-1.5 rounded-lg hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    title="Sync Now"
  >
    <FiRefreshCw className={`w-4 h-4 text-zinc-600 dark:text-zinc-400 ${syncing ? 'animate-spin' : ''}`} />
  </button>
</div>
```

Note: FiClock and FiRefreshCw are already imported in Dashboard.jsx.
  </action>
  <verify>
1. Build succeeds:
```bash
cd frontend && npm run build
```

2. Start dev server and visually verify:
```bash
cd frontend && npm run dev &
sleep 3
echo "Visit http://localhost:5173/app/dashboard to verify sync status appears in header"
```
  </verify>
  <done>
Dashboard header shows:
- "Last synced: X ago" indicator (yellow if stale >6h)
- Sync Now button with refresh icon
- Button spins and is disabled while syncing
- Toast notification appears on sync completion
  </done>
</task>

</tasks>

<verification>
1. Dashboard loads and shows sync status in header
2. Sync status shows relative time (e.g., "2h ago", "Never synced")
3. Stale data (>6h) shows yellow warning color
4. Clicking Sync Now button:
   - Button disables and icon spins
   - API call is made to /api/fmcsa/sync-violations
   - Toast appears with result
   - Sync status updates to "Just now"
   - Button re-enables
5. No console errors
</verification>

<success_criteria>
- [ ] Sync status visible in Dashboard header
- [ ] formatLastSync displays human-readable relative time
- [ ] Stale indicator (yellow) appears when >6 hours since last sync
- [ ] Sync Now button triggers fmcsaAPI.syncViolations
- [ ] Toast notification shows violation count or "no new violations"
- [ ] Button properly disabled during sync with spinner
- [ ] Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish/07-01-SUMMARY.md`
</output>
