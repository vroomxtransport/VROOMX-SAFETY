---
phase: 07-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/UnlinkedViolations.jsx
  - frontend/src/App.jsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to unlinked violations page"
    - "Page shows table of violations without linked drivers"
    - "User can click to link a driver to a violation"
    - "Empty state shows when all violations are linked"
  artifacts:
    - path: "frontend/src/pages/UnlinkedViolations.jsx"
      provides: "Unlinked violations review page"
      min_lines: 100
    - path: "frontend/src/App.jsx"
      provides: "Route for unlinked-violations page"
      contains: "unlinked-violations"
  key_links:
    - from: "frontend/src/pages/UnlinkedViolations.jsx"
      to: "/api/violations/unassigned"
      via: "violationsAPI.getUnassigned on mount"
      pattern: "violationsAPI\\.getUnassigned"
    - from: "frontend/src/pages/UnlinkedViolations.jsx"
      to: "/api/violations/:id/link-driver"
      via: "violationsAPI.linkDriver on form submit"
      pattern: "violationsAPI\\.linkDriver"
---

<objective>
Create the Unlinked Violations review page for manual driver linking.

Purpose: When violations cannot be auto-linked to drivers (no CDL match), they need manual review. This page lists all unassigned violations and allows users to link them to drivers manually (UI-03).

Output: New UnlinkedViolations.jsx page with DataTable, link driver modal, and route in App.jsx.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish/07-RESEARCH.md

# Key reference files
@frontend/src/pages/Violations.jsx (DataTable pattern, link driver modal pattern)
@frontend/src/components/DataTable.jsx (table component API)
@frontend/src/utils/api.js (violationsAPI.getUnassigned, linkDriver)
@frontend/src/App.jsx (route registration pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UnlinkedViolations page component</name>
  <files>frontend/src/pages/UnlinkedViolations.jsx</files>
  <action>
Create new file `frontend/src/pages/UnlinkedViolations.jsx`:

```jsx
import { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import {
  FiAlertTriangle, FiUserPlus, FiRefreshCw, FiCheckCircle,
  FiArrowLeft, FiCalendar, FiTruck
} from 'react-icons/fi';
import toast from 'react-hot-toast';
import { violationsAPI, driversAPI } from '../utils/api';
import DataTable from '../components/DataTable';
import Modal from '../components/Modal';
import LoadingSpinner from '../components/LoadingSpinner';

const UnlinkedViolations = () => {
  const [violations, setViolations] = useState([]);
  const [drivers, setDrivers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({ page: 1, limit: 20, total: 0 });

  // Link modal state
  const [showLinkModal, setShowLinkModal] = useState(false);
  const [selectedViolation, setSelectedViolation] = useState(null);
  const [selectedDriverId, setSelectedDriverId] = useState('');
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    fetchData();
  }, [pagination.page]);

  const fetchData = async () => {
    setLoading(true);
    try {
      const [violationsRes, driversRes] = await Promise.all([
        violationsAPI.getUnassigned({
          page: pagination.page,
          limit: pagination.limit
        }),
        driversAPI.getAll({ status: 'active', limit: 500 })
      ]);

      setViolations(violationsRes.data.violations || []);
      setPagination(prev => ({
        ...prev,
        total: violationsRes.data.pagination?.total || 0
      }));
      setDrivers(driversRes.data.drivers || []);
    } catch (err) {
      toast.error('Failed to load unlinked violations');
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (date) => {
    if (!date) return '-';
    return new Date(date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const openLinkModal = (violation) => {
    setSelectedViolation(violation);
    setSelectedDriverId('');
    setShowLinkModal(true);
  };

  const handleLinkDriver = async (e) => {
    e.preventDefault();
    if (!selectedDriverId || !selectedViolation) {
      toast.error('Please select a driver');
      return;
    }

    setSubmitting(true);
    try {
      await violationsAPI.linkDriver(selectedViolation._id, selectedDriverId);
      toast.success('Driver linked to violation');
      setShowLinkModal(false);
      setSelectedViolation(null);
      setSelectedDriverId('');
      // Refresh the list
      await fetchData();
    } catch (err) {
      toast.error(err.response?.data?.message || 'Failed to link driver');
    } finally {
      setSubmitting(false);
    }
  };

  const columns = [
    {
      header: 'Date',
      accessor: 'violationDate',
      render: (row) => (
        <div className="flex items-center gap-2">
          <FiCalendar className="w-4 h-4 text-zinc-400" />
          <span className="font-mono text-sm">{formatDate(row.violationDate)}</span>
        </div>
      )
    },
    {
      header: 'Violation',
      accessor: 'violationType',
      render: (row) => (
        <div>
          <p className="font-medium text-zinc-900 dark:text-white">{row.violationType}</p>
          <p className="text-xs text-zinc-500 dark:text-zinc-400">{row.violationCode}</p>
        </div>
      )
    },
    {
      header: 'BASIC',
      accessor: 'basic',
      render: (row) => (
        <span className="px-2 py-1 rounded-full text-xs font-medium bg-zinc-100 dark:bg-zinc-800 text-zinc-700 dark:text-zinc-300">
          {row.basic?.replace(/_/g, ' ') || 'Unknown'}
        </span>
      )
    },
    {
      header: 'State',
      accessor: 'state',
      render: (row) => (
        <span className="text-sm text-zinc-600 dark:text-zinc-400">{row.state || '-'}</span>
      )
    },
    {
      header: 'Severity',
      accessor: 'severityWeight',
      render: (row) => {
        const severity = row.severityWeight || 0;
        const color = severity >= 8 ? 'red' : severity >= 5 ? 'yellow' : 'green';
        return (
          <span className={`px-2 py-1 rounded-full text-xs font-medium bg-${color}-100 dark:bg-${color}-500/20 text-${color}-700 dark:text-${color}-400`}>
            {severity} pts
          </span>
        );
      }
    },
    {
      header: '',
      accessor: 'actions',
      render: (row) => (
        <button
          onClick={() => openLinkModal(row)}
          className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium bg-accent-50 dark:bg-accent-500/10 text-accent-600 dark:text-accent-400 hover:bg-accent-100 dark:hover:bg-accent-500/20 transition-colors"
        >
          <FiUserPlus className="w-4 h-4" />
          Link Driver
        </button>
      )
    }
  ];

  if (loading && violations.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-64">
        <LoadingSpinner size="lg" variant="truck" />
        <p className="mt-4 text-sm text-zinc-600 dark:text-zinc-300">Loading unlinked violations...</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <div className="flex items-center gap-3 mb-2">
            <Link
              to="/app/violations"
              className="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors"
            >
              <FiArrowLeft className="w-5 h-5 text-zinc-600 dark:text-zinc-400" />
            </Link>
            <h1 className="text-2xl font-bold text-zinc-900 dark:text-white">Unlinked Violations</h1>
          </div>
          <p className="text-zinc-600 dark:text-zinc-400">
            {pagination.total} violation{pagination.total !== 1 ? 's' : ''} need manual driver assignment
          </p>
        </div>
        <button
          onClick={fetchData}
          disabled={loading}
          className="flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-300 transition-colors"
        >
          <FiRefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
          Refresh
        </button>
      </div>

      {/* Empty State */}
      {violations.length === 0 && !loading && (
        <div className="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 p-12 text-center">
          <div className="w-16 h-16 rounded-full bg-green-100 dark:bg-green-500/20 flex items-center justify-center mx-auto mb-4">
            <FiCheckCircle className="w-8 h-8 text-green-500" />
          </div>
          <h3 className="text-lg font-semibold text-zinc-900 dark:text-white mb-2">
            All Violations Linked
          </h3>
          <p className="text-zinc-600 dark:text-zinc-400 mb-4">
            All violations have been linked to drivers. Great job!
          </p>
          <Link
            to="/app/violations"
            className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-accent-500 hover:bg-accent-600 text-white transition-colors"
          >
            View All Violations
          </Link>
        </div>
      )}

      {/* Data Table */}
      {violations.length > 0 && (
        <div className="bg-white dark:bg-zinc-900 rounded-2xl border border-zinc-200 dark:border-zinc-800 overflow-hidden">
          <DataTable
            columns={columns}
            data={violations}
            loading={loading}
            pagination={{
              currentPage: pagination.page,
              totalPages: Math.ceil(pagination.total / pagination.limit),
              totalItems: pagination.total,
              itemsPerPage: pagination.limit,
              onPageChange: (page) => setPagination(prev => ({ ...prev, page }))
            }}
            emptyMessage="No unlinked violations found"
          />
        </div>
      )}

      {/* Link Driver Modal */}
      <Modal
        isOpen={showLinkModal}
        onClose={() => {
          setShowLinkModal(false);
          setSelectedViolation(null);
          setSelectedDriverId('');
        }}
        title="Link Driver to Violation"
        icon={FiUserPlus}
      >
        <form onSubmit={handleLinkDriver} className="space-y-5">
          {/* Violation Context */}
          <div className="p-4 rounded-xl bg-accent-50 dark:bg-accent-500/10 border border-accent-200 dark:border-accent-500/30">
            <div className="flex items-start gap-3">
              <FiAlertTriangle className="w-5 h-5 text-accent-600 dark:text-accent-400 mt-0.5" />
              <div>
                <p className="text-sm font-medium text-accent-800 dark:text-accent-300">Violation:</p>
                <p className="text-sm text-accent-700 dark:text-accent-400">{selectedViolation?.violationType}</p>
                <p className="text-xs text-accent-600 dark:text-accent-500 mt-1">
                  {selectedViolation?.violationDate && formatDate(selectedViolation.violationDate)} | {selectedViolation?.basic?.replace(/_/g, ' ')}
                </p>
                {selectedViolation?.state && (
                  <p className="text-xs text-accent-600 dark:text-accent-500">
                    State: {selectedViolation.state}
                  </p>
                )}
              </div>
            </div>
          </div>

          {/* Driver Selection */}
          <div>
            <label className="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-2">
              Select Driver
            </label>
            <select
              className="w-full px-4 py-2.5 rounded-xl border border-zinc-300 dark:border-zinc-600 bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
              value={selectedDriverId}
              onChange={(e) => setSelectedDriverId(e.target.value)}
              required
            >
              <option value="">Select a driver...</option>
              {drivers.map(driver => (
                <option key={driver._id} value={driver._id}>
                  {driver.firstName} {driver.lastName}
                  {driver.cdlNumber && ` (CDL: ${driver.cdlNumber})`}
                </option>
              ))}
            </select>
          </div>

          {/* Actions */}
          <div className="flex gap-3 pt-2">
            <button
              type="button"
              onClick={() => {
                setShowLinkModal(false);
                setSelectedViolation(null);
                setSelectedDriverId('');
              }}
              className="flex-1 px-4 py-2.5 rounded-xl border border-zinc-300 dark:border-zinc-600 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={submitting || !selectedDriverId}
              className="flex-1 px-4 py-2.5 rounded-xl bg-accent-500 hover:bg-accent-600 text-white font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {submitting ? (
                <>
                  <FiRefreshCw className="w-4 h-4 animate-spin" />
                  Linking...
                </>
              ) : (
                <>
                  <FiUserPlus className="w-4 h-4" />
                  Link Driver
                </>
              )}
            </button>
          </div>
        </form>
      </Modal>
    </div>
  );
};

export default UnlinkedViolations;
```
  </action>
  <verify>
File exists and has valid syntax:
```bash
ls -la frontend/src/pages/UnlinkedViolations.jsx
cd frontend && npx eslint src/pages/UnlinkedViolations.jsx --quiet 2>&1 | head -10
```
  </verify>
  <done>UnlinkedViolations.jsx component created with DataTable, link modal, and empty state</done>
</task>

<task type="auto">
  <name>Task 2: Add route for UnlinkedViolations page</name>
  <files>frontend/src/App.jsx</files>
  <action>
Add route for the new UnlinkedViolations page in App.jsx:

1. Add import at top with other page imports (lazy load for consistency):
```javascript
const UnlinkedViolations = lazy(() => import('./pages/UnlinkedViolations'));
```

2. Add route inside the /app routes section, after the violations route (~line 229):
```jsx
<Route path="unlinked-violations" element={<Suspense fallback={<LoadingSpinner size="lg" />}><UnlinkedViolations /></Suspense>} />
```

Place it right after the `violations` route to keep related pages together.
  </action>
  <verify>
Build succeeds with new route:
```bash
cd frontend && npm run build
```
  </verify>
  <done>Route /app/unlinked-violations registered and loads UnlinkedViolations component</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation link to Unlinked Violations from Violations page</name>
  <files>frontend/src/pages/Violations.jsx</files>
  <action>
Add a link/button to navigate to the Unlinked Violations page from the main Violations page.

1. In Violations.jsx, find the header section where action buttons are (near the "Add Violation" button)

2. Add a link to unlinked violations, conditionally shown when there are unassigned violations. Add after the header buttons:

```jsx
<Link
  to="/app/unlinked-violations"
  className="flex items-center gap-2 px-4 py-2 rounded-lg bg-yellow-50 dark:bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 hover:bg-yellow-100 dark:hover:bg-yellow-500/20 transition-colors border border-yellow-200 dark:border-yellow-500/30"
>
  <FiUserPlus className="w-4 h-4" />
  Review Unlinked
</Link>
```

This provides a direct navigation path to review unassigned violations.
  </action>
  <verify>
Build succeeds:
```bash
cd frontend && npm run build
```
  </verify>
  <done>Navigation link added from Violations page to Unlinked Violations page</done>
</task>

</tasks>

<verification>
1. Navigate to /app/unlinked-violations in browser
2. Page loads with table of violations without drivers
3. Each row has "Link Driver" button
4. Clicking "Link Driver" opens modal with driver dropdown
5. Selecting driver and submitting links the violation
6. Violation disappears from list after linking
7. Empty state shows when all violations are linked
8. Back link returns to /app/violations
9. "Review Unlinked" link appears on Violations page
10. No console errors
</verification>

<success_criteria>
- [ ] UnlinkedViolations.jsx component created
- [ ] Route registered at /app/unlinked-violations
- [ ] Page fetches from violationsAPI.getUnassigned
- [ ] DataTable displays violations with columns: Date, Violation, BASIC, State, Severity, Actions
- [ ] Link Driver modal opens with driver selection
- [ ] Successful linking removes violation from list
- [ ] Empty state shown when no unlinked violations
- [ ] Navigation link from Violations page
- [ ] Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish/07-02-SUMMARY.md`
</output>
