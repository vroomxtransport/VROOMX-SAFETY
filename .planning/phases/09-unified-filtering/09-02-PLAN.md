---
phase: 09-unified-filtering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/filters/DateRangeFilter.jsx
  - frontend/src/components/filters/MultiSelectDropdown.jsx
  - frontend/src/components/filters/StatusFilter.jsx
  - frontend/src/components/filters/ReportFilters.jsx
  - frontend/src/pages/Reports.jsx
autonomous: true

must_haves:
  truths:
    - "User can select date preset buttons and see date fields auto-populate"
    - "User can select multiple drivers from checkbox dropdown"
    - "User can select multiple vehicles from checkbox dropdown"
    - "User can filter by status using single-select dropdown"
    - "Filter changes trigger report generation with debounced API call"
  artifacts:
    - path: "frontend/src/components/filters/DateRangeFilter.jsx"
      provides: "Date inputs with preset buttons"
      min_lines: 40
    - path: "frontend/src/components/filters/MultiSelectDropdown.jsx"
      provides: "Checkbox-based multi-select dropdown"
      min_lines: 60
    - path: "frontend/src/components/filters/StatusFilter.jsx"
      provides: "Single-select status dropdown"
      min_lines: 20
    - path: "frontend/src/components/filters/ReportFilters.jsx"
      provides: "Composable filter container"
      min_lines: 50
    - path: "frontend/src/pages/Reports.jsx"
      provides: "Reports page with integrated filters"
      contains: "ReportFilters"
  key_links:
    - from: "frontend/src/components/filters/ReportFilters.jsx"
      to: "frontend/src/utils/datePresets.js"
      via: "import getDatePresets"
      pattern: "import.*datePresets"
    - from: "frontend/src/pages/Reports.jsx"
      to: "frontend/src/components/filters/ReportFilters.jsx"
      via: "component usage"
      pattern: "<ReportFilters"
    - from: "frontend/src/pages/Reports.jsx"
      to: "reportsAPI"
      via: "filter params passed to API"
      pattern: "report\\.api.*filters"
---

<objective>
Create reusable filter UI components and integrate them into the Reports page for unified filtering across all report types.

Purpose: Enable users to filter reports by date range, drivers, vehicles, and status with an intuitive UI.
Output: Working filter components integrated into Reports.jsx with debounced filter updates.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-unified-filtering/09-RESEARCH.md

# Existing patterns
@frontend/src/pages/Reports.jsx
@frontend/src/pages/Violations.jsx (filter UI pattern lines 546-593)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create filter sub-components</name>
  <files>
    frontend/src/components/filters/DateRangeFilter.jsx
    frontend/src/components/filters/MultiSelectDropdown.jsx
    frontend/src/components/filters/StatusFilter.jsx
  </files>
  <action>
Create directory `frontend/src/components/filters/` if not exists.

**DateRangeFilter.jsx:**
```jsx
import { getDatePresets, getActivePreset } from '../../utils/datePresets';

const DateRangeFilter = ({ startDate, endDate, onChange }) => {
  const presets = getDatePresets();
  const activePreset = getActivePreset(startDate, endDate);

  const handlePresetClick = (preset) => {
    onChange(preset.startDate, preset.endDate);
  };

  return (
    <div className="space-y-3">
      {/* Preset buttons */}
      <div className="flex flex-wrap gap-2">
        {presets.map((preset) => (
          <button
            key={preset.key}
            type="button"
            onClick={() => handlePresetClick(preset)}
            className={`px-3 py-1.5 text-sm rounded-lg transition-colors ${
              activePreset === preset.key
                ? 'bg-primary-600 text-white'
                : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-200 dark:hover:bg-zinc-700'
            }`}
          >
            {preset.label}
          </button>
        ))}
      </div>
      {/* Date inputs */}
      <div className="flex flex-col sm:flex-row gap-4">
        <div className="flex-1">
          <label className="form-label">Start Date</label>
          <input
            type="date"
            className="form-input"
            value={startDate}
            onChange={(e) => onChange(e.target.value, endDate)}
          />
        </div>
        <div className="flex-1">
          <label className="form-label">End Date</label>
          <input
            type="date"
            className="form-input"
            value={endDate}
            max={new Date().toISOString().split('T')[0]}
            onChange={(e) => onChange(startDate, e.target.value)}
          />
        </div>
      </div>
    </div>
  );
};

export default DateRangeFilter;
```

**MultiSelectDropdown.jsx:**
- Props: `label`, `options` (array of {value, label}), `selected` (array of values), `onChange`, `placeholder`
- useState for `isOpen` toggle
- useRef + useEffect for click-outside detection (close dropdown)
- Render button showing: placeholder if none selected, single label if one selected, "N selected" if multiple
- Clear button (X icon) when selections exist
- Dropdown panel with checkboxes for each option
- Use FiChevronDown, FiX from react-icons/fi
- Tailwind classes matching existing codebase: form-select, dark mode support
- Handle checkbox toggle: if selected includes value, filter it out; else add it

**StatusFilter.jsx:**
```jsx
const StatusFilter = ({ options, value, onChange }) => {
  return (
    <div className="min-w-[150px]">
      <label className="form-label">Status</label>
      <select
        className="form-select w-full"
        value={value}
        onChange={(e) => onChange(e.target.value)}
      >
        {options.map((opt) => (
          <option key={opt.value} value={opt.value}>
            {opt.label}
          </option>
        ))}
      </select>
    </div>
  );
};

export default StatusFilter;
```
  </action>
  <verify>
Check files exist and have expected structure:
```bash
ls -la frontend/src/components/filters/
head -30 frontend/src/components/filters/DateRangeFilter.jsx
head -30 frontend/src/components/filters/MultiSelectDropdown.jsx
```
  </verify>
  <done>
Three filter sub-components created: DateRangeFilter with preset buttons and date inputs, MultiSelectDropdown with checkbox-based selection, StatusFilter with single-select dropdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReportFilters container component</name>
  <files>frontend/src/components/filters/ReportFilters.jsx</files>
  <action>
Create the main composable filter component:

```jsx
import { useState, useEffect, useCallback } from 'react';
import DateRangeFilter from './DateRangeFilter';
import MultiSelectDropdown from './MultiSelectDropdown';
import StatusFilter from './StatusFilter';

const ReportFilters = ({
  onFilterChange,
  enableDateRange = false,
  enableDriverFilter = false,
  enableVehicleFilter = false,
  enableStatusFilter = false,
  drivers = [],
  vehicles = [],
  statusOptions = [],
  initialFilters = {}
}) => {
  const [filters, setFilters] = useState({
    startDate: '',
    endDate: '',
    driverIds: [],
    vehicleIds: [],
    status: '',
    ...initialFilters
  });

  // Debounce filter changes (300ms)
  useEffect(() => {
    const timer = setTimeout(() => {
      onFilterChange(filters);
    }, 300);
    return () => clearTimeout(timer);
  }, [filters, onFilterChange]);

  const handleDateChange = useCallback((startDate, endDate) => {
    setFilters(prev => ({ ...prev, startDate, endDate }));
  }, []);

  const handleDriversChange = useCallback((driverIds) => {
    setFilters(prev => ({ ...prev, driverIds }));
  }, []);

  const handleVehiclesChange = useCallback((vehicleIds) => {
    setFilters(prev => ({ ...prev, vehicleIds }));
  }, []);

  const handleStatusChange = useCallback((status) => {
    setFilters(prev => ({ ...prev, status }));
  }, []);

  // Check if any filters are enabled
  const hasFilters = enableDateRange || enableDriverFilter || enableVehicleFilter || enableStatusFilter;

  if (!hasFilters) return null;

  return (
    <div className="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200/60 dark:border-zinc-800 p-4">
      <div className="flex flex-col gap-4">
        {enableDateRange && (
          <DateRangeFilter
            startDate={filters.startDate}
            endDate={filters.endDate}
            onChange={handleDateChange}
          />
        )}
        <div className="flex flex-wrap gap-4">
          {enableDriverFilter && (
            <MultiSelectDropdown
              label="Drivers"
              options={drivers.map(d => ({
                value: d._id,
                label: `${d.firstName} ${d.lastName}`
              }))}
              selected={filters.driverIds}
              onChange={handleDriversChange}
              placeholder="All Drivers"
            />
          )}
          {enableVehicleFilter && (
            <MultiSelectDropdown
              label="Vehicles"
              options={vehicles.map(v => ({
                value: v._id,
                label: v.unitNumber
              }))}
              selected={filters.vehicleIds}
              onChange={handleVehiclesChange}
              placeholder="All Vehicles"
            />
          )}
          {enableStatusFilter && statusOptions.length > 0 && (
            <StatusFilter
              options={statusOptions}
              value={filters.status}
              onChange={handleStatusChange}
            />
          )}
        </div>
      </div>
    </div>
  );
};

export default ReportFilters;
```

Key features:
- Conditional rendering based on enable* props
- 300ms debounce on filter changes via useEffect
- useCallback for stable handler references
- Returns null if no filters enabled (audit report)
  </action>
  <verify>
Check file exists with correct structure:
```bash
grep -c "useCallback" frontend/src/components/filters/ReportFilters.jsx
grep "setTimeout" frontend/src/components/filters/ReportFilters.jsx
```
Should show useCallback usage and debounce timer.
  </verify>
  <done>
ReportFilters component created with debounced filter updates (300ms), conditional rendering of sub-components based on enable flags, and proper state management with useCallback handlers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate filters into Reports.jsx</name>
  <files>frontend/src/pages/Reports.jsx</files>
  <action>
Refactor Reports.jsx to use the new filter components:

1. **Add imports:**
```jsx
import { useState, useEffect, useCallback } from 'react';
import ReportFilters from '../components/filters/ReportFilters';
import { REPORT_FILTER_CONFIG } from '../utils/reportFilterConfig';
import { driversAPI, vehiclesAPI, reportsAPI } from '../utils/api';
```

2. **Add state for drivers/vehicles lists:**
```jsx
const [drivers, setDrivers] = useState([]);
const [vehicles, setVehicles] = useState([]);
const [activeFilters, setActiveFilters] = useState({});
```

3. **Fetch drivers and vehicles on mount:**
```jsx
useEffect(() => {
  const fetchFilterData = async () => {
    try {
      const [driversRes, vehiclesRes] = await Promise.all([
        driversAPI.getAll({ status: 'active', limit: 500 }),
        vehiclesAPI.getAll({ status: 'active', limit: 500 })
      ]);
      setDrivers(driversRes.data.drivers || driversRes.data || []);
      setVehicles(vehiclesRes.data.vehicles || vehiclesRes.data || []);
    } catch (error) {
      console.error('Failed to load filter data:', error);
    }
  };
  fetchFilterData();
}, []);
```

4. **Create filter change handler:**
```jsx
const handleFilterChange = useCallback((filters) => {
  setActiveFilters(filters);
}, []);
```

5. **Update handleGenerateReport to include filters:**
```jsx
const handleGenerateReport = async (reportId, format = 'pdf') => {
  const report = reports.find(r => r.id === reportId);
  if (!report) return;

  setGenerating({ ...generating, [reportId]: format });

  try {
    // Build params from active filters + format
    const config = REPORT_FILTER_CONFIG[reportId] || {};
    const params = { format };

    if (config.enableDateRange && activeFilters.startDate) {
      params.startDate = activeFilters.startDate;
    }
    if (config.enableDateRange && activeFilters.endDate) {
      params.endDate = activeFilters.endDate;
    }
    if (config.enableDriverFilter && activeFilters.driverIds?.length) {
      params.driverIds = activeFilters.driverIds;
    }
    if (config.enableVehicleFilter && activeFilters.vehicleIds?.length) {
      params.vehicleIds = activeFilters.vehicleIds;
    }
    if (config.enableStatusFilter && activeFilters.status) {
      params.complianceStatus = activeFilters.status;
      // For violations, use 'status' param name
      if (reportId === 'violations') {
        params.status = activeFilters.status;
        delete params.complianceStatus;
      }
    }

    const response = await report.api(params);
    // ... rest unchanged
  }
  // ... error handling unchanged
};
```

6. **Replace the hardcoded date range filter section with ReportFilters:**
Remove the old "Date Range Filter (for Violations Report)" card.

Add new filter section before Report Cards:
```jsx
{/* Report Filters */}
<ReportFilters
  onFilterChange={handleFilterChange}
  enableDateRange={true}
  enableDriverFilter={true}
  enableVehicleFilter={true}
  enableStatusFilter={true}
  drivers={drivers}
  vehicles={vehicles}
  statusOptions={[
    { value: '', label: 'All Status' },
    { value: 'compliant', label: 'Compliant' },
    { value: 'warning', label: 'Warning' },
    { value: 'non_compliant', label: 'Non-Compliant' }
  ]}
/>
```

7. **Update report card descriptions to mention filtering:**
Update descriptions to indicate which filters apply (optional enhancement).

8. **Remove old dateRange state and hasDateRange property** from reports array since filters now apply universally based on config.
  </action>
  <verify>
```bash
grep -c "ReportFilters" frontend/src/pages/Reports.jsx
grep -c "REPORT_FILTER_CONFIG" frontend/src/pages/Reports.jsx
npm run lint --prefix frontend 2>&1 | head -20
```
Should show ReportFilters import and usage, no lint errors.
  </verify>
  <done>
Reports.jsx refactored with: ReportFilters component integrated, drivers/vehicles fetched on mount, filter state passed to API calls, old hardcoded date filter removed. Users can now filter any report by date range, drivers, vehicles, and status.
  </done>
</task>

</tasks>

<verification>
1. All filter components exist in frontend/src/components/filters/
2. DateRangeFilter shows preset buttons that populate date fields
3. MultiSelectDropdown allows selecting multiple items with checkboxes
4. StatusFilter provides single-select status filtering
5. ReportFilters conditionally renders enabled filters
6. Reports.jsx integrates ReportFilters and passes filter params to API
7. No lint errors in any modified files
8. Filter changes are debounced (300ms delay before API call)
</verification>

<success_criteria>
- User can click "Last 30 Days" and see date fields auto-populate
- User can open Drivers dropdown and check multiple drivers
- User can open Vehicles dropdown and check multiple vehicles
- User can select a compliance status from dropdown
- Generating a report with filters applied returns filtered results
- Filters work across all report types (DQF, Vehicle, Violations, Audit)
</success_criteria>

<output>
After completion, create `.planning/phases/09-unified-filtering/09-02-SUMMARY.md`
</output>
