---
phase: 06-dataq-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/services/fmcsaSyncOrchestrator.js
autonomous: true

must_haves:
  truths:
    - "Sync orchestrator runs DataQ analysis as step 5 after entity linking"
    - "DataQ analysis failures do not crash the sync (error isolation)"
    - "Company.syncStatus.dataQAnalysisLastRun is updated after analysis completes"
  artifacts:
    - path: "backend/services/fmcsaSyncOrchestrator.js"
      provides: "Step 5 DataQ analysis integration"
      contains: "dataQAnalysisService"
  key_links:
    - from: "backend/services/fmcsaSyncOrchestrator.js"
      to: "backend/services/dataQAnalysisService.js"
      via: "runBulkAnalysis call"
      pattern: "dataQAnalysisService\\.runBulkAnalysis"
    - from: "backend/services/fmcsaSyncOrchestrator.js"
      to: "Company.fmcsaData.syncStatus.dataQAnalysisLastRun"
      via: "updateOne after analysis"
      pattern: "dataQAnalysisLastRun"
---

<objective>
Integrate DataQ analysis into FMCSA sync orchestrator as step 5

Purpose: After violations are synced and linked to entities, automatically score them for DataQ challenge potential so users see opportunities immediately without manual refresh.

Output: Sync orchestrator with DataQ analysis step that runs after entity linking, matching the established error-isolation pattern.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-dataq-integration/06-RESEARCH.md
@.planning/phases/06-dataq-integration/06-01-SUMMARY.md

# Key source file
@backend/services/fmcsaSyncOrchestrator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DataQ analysis as step 5 in sync orchestrator</name>
  <files>backend/services/fmcsaSyncOrchestrator.js</files>
  <action>
Modify fmcsaSyncOrchestrator.js to add DataQ analysis as step 5 after entity linking.

1. Add lazy require for dataQAnalysisService (matches pattern from entityLinkingService):
   At the top with other requires, add:
   ```javascript
   const dataQAnalysisService = require('./dataQAnalysisService');
   ```

2. In `syncCompany()` method, add step 5 AFTER the entity linking block (step 4), BEFORE the "Update Company sync status" section:

```javascript
// 5. Run DataQ analysis on newly-synced violations
try {
  console.log(`[FMCSA Orchestrator] Running DataQ analysis for company ${companyId}`);
  const dataQResult = await dataQAnalysisService.runBulkAnalysis(companyId);
  timestamps.dataQAnalysisLastRun = new Date();
  timestamps.dataQAnalysisCount = dataQResult.analyzed;
  console.log(`[FMCSA Orchestrator] DataQ analysis complete: ${dataQResult.analyzed} violations scored`);
} catch (err) {
  console.error(`[FMCSA Orchestrator] DataQ analysis failed:`, err.message);
  errors.push({ source: 'dataq_analysis', error: err.message, timestamp: new Date() });
}
```

3. Update the Company.updateOne call to include the new fields:
   Add these lines in the $set block (after linkingLastRun):
   ```javascript
   ...(timestamps.dataQAnalysisLastRun && { 'fmcsaData.syncStatus.dataQAnalysisLastRun': timestamps.dataQAnalysisLastRun }),
   ...(timestamps.dataQAnalysisCount !== undefined && { 'fmcsaData.syncStatus.dataQAnalysisCount': timestamps.dataQAnalysisCount })
   ```

Key patterns to follow (from existing entity linking step):
- Try/catch block that logs but doesn't throw
- Timestamps tracked separately, merged at end
- Errors added to array with source identifier
- Console logs with [FMCSA Orchestrator] prefix
  </action>
  <verify>
1. Check service exports the expected structure:
   `cd "/Users/reepsy/Documents/TRUCKING COMPLIANCE HUB1/backend" && node -e "const orch = require('./services/fmcsaSyncOrchestrator'); console.log('syncCompany exists:', typeof orch.syncCompany === 'function')"`

2. Check file contains DataQ integration:
   `grep -c "dataQAnalysisService" "/Users/reepsy/Documents/TRUCKING COMPLIANCE HUB1/backend/services/fmcsaSyncOrchestrator.js"`

Expected: Function exists and file contains dataQAnalysisService references (count > 0)
  </verify>
  <done>Sync orchestrator has step 5 that runs DataQ bulk analysis after entity linking, with proper error isolation</done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end sync flow</name>
  <files>None (verification only)</files>
  <action>
Verify the complete sync flow works without errors:

1. Start the backend server to ensure no require/import errors
2. Check all services can be loaded together
3. Verify the orchestrator's syncCompany method can be called (mock test)

Run these verifications:
```bash
cd "/Users/reepsy/Documents/TRUCKING COMPLIANCE HUB1/backend"

# Test 1: All services load without error
node -e "
const Company = require('./models/Company');
const dataQService = require('./services/dataQAnalysisService');
const orchestrator = require('./services/fmcsaSyncOrchestrator');
console.log('All services loaded successfully');
console.log('Company syncStatus schema:', Object.keys(Company.schema.obj.fmcsaData.syncStatus));
console.log('dataQService.runBulkAnalysis:', typeof dataQService.runBulkAnalysis);
console.log('orchestrator.syncCompany:', typeof orchestrator.syncCompany);
"

# Test 2: Server starts (will exit on Ctrl+C)
timeout 5 npm start 2>&1 | head -20
```

This is a verification task - no code changes, just confirm the integration works.
  </action>
  <verify>
All services load without errors, server starts successfully
  </verify>
  <done>End-to-end verification passes: services load, schema correct, server starts</done>
</task>

</tasks>

<verification>
1. Orchestrator file contains:
   - require('./dataQAnalysisService') at top
   - Step 5 comment and implementation
   - dataQAnalysisLastRun in Company.updateOne

2. Full integration test:
   - All services load without circular dependency errors
   - Server starts without runtime errors
   - syncCompany method references dataQAnalysisService.runBulkAnalysis
</verification>

<success_criteria>
- Sync orchestrator has 5 steps: CSA scores, violations, inspections, entity linking, DataQ analysis
- DataQ analysis step follows same error-isolation pattern as entity linking
- Server starts without errors
- No AI calls made (local scoring only, per RESEARCH.md recommendation)
</success_criteria>

<output>
After completion, create `.planning/phases/06-dataq-integration/06-02-SUMMARY.md`
</output>
