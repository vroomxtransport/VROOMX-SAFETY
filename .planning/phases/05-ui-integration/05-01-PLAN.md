---
phase: 05-ui-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/services/vehicleOOSService.js
autonomous: true

must_haves:
  truths:
    - "OOS rate can be calculated for any vehicle with linked violations"
    - "BASIC breakdown shows violation counts per category for a vehicle"
    - "Service returns paginated violations for a specific vehicle"
  artifacts:
    - path: "backend/services/vehicleOOSService.js"
      provides: "Vehicle OOS rate calculation and violation retrieval"
      exports: ["getVehicleOOSStats", "getVehicleViolations"]
      min_lines: 100
  key_links:
    - from: "backend/services/vehicleOOSService.js"
      to: "backend/models/Violation"
      via: "Violation.find({ vehicleId })"
      pattern: "Violation\\.find.*vehicleId"
    - from: "backend/services/vehicleOOSService.js"
      to: "backend/models/Vehicle"
      via: "Vehicle.findOne verification"
      pattern: "Vehicle\\.findOne"
---

<objective>
Create backend service for calculating vehicle OOS rates and retrieving vehicle-linked violations.

Purpose: Enable vehicle profile pages to display violation history and OOS metrics (VHCL-03, VHCL-04 requirements)
Output: `vehicleOOSService.js` with calculation methods mirroring `driverCSAService.js` pattern
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-integration/05-RESEARCH.md

# Reference implementation to mirror
@backend/services/driverCSAService.js
@backend/models/Violation.js
@backend/models/Vehicle.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vehicleOOSService.js</name>
  <files>backend/services/vehicleOOSService.js</files>
  <action>
Create `backend/services/vehicleOOSService.js` following the exact pattern from `driverCSAService.js`:

1. **getVehicleOOSStats(vehicleId, companyId)** - Main stats method:
   - Verify vehicle exists and belongs to company (Vehicle.findOne)
   - Query violations linked to this vehicle from last 24 months
   - Calculate:
     - totalViolations: count of all violations
     - oosViolations: count where outOfService === true
     - oosRate: (oosViolations / totalViolations * 100).toFixed(1), or 0 if no violations
   - Call _calculateBasicBreakdown(violations) for BASIC category breakdown
   - Return vehicle info, stats, basicBreakdown, and 5 most recent violations

2. **getVehicleViolations(vehicleId, companyId, filters)** - Paginated violations:
   - Accept filters: { page = 1, limit = 20, basic, sortBy = 'violationDate', sortOrder = 'desc' }
   - Query Violation.find({ vehicleId, companyId })
   - Apply basic filter if provided
   - Return { violations, pagination: { total, page, limit, pages } }
   - Populate driverId with 'firstName lastName employeeId' (show who was driving)

3. **_calculateBasicBreakdown(violations)** - Private helper:
   - Same logic as driverCSAService._calculateBasicBreakdown
   - Track count, oosCount per BASIC category
   - Include _getBasicName() helper for human-readable names

4. **Module exports:**
   - Export as object literal (not class) matching codebase pattern:
     `module.exports = vehicleOOSService;`

Key differences from driver service:
- Use vehicleId instead of driverId in queries
- Calculate oosRate instead of CSA risk score (simpler calculation)
- No riskLevel determination needed (that's driver-specific)
- Populate driverId in violations (to show who was driving during inspection)
  </action>
  <verify>
    - File exists: `ls backend/services/vehicleOOSService.js`
    - Exports correct methods: `node -e "const s = require('./backend/services/vehicleOOSService'); console.log(Object.keys(s))"`
    - Expected output includes: getVehicleOOSStats, getVehicleViolations
  </verify>
  <done>
    - vehicleOOSService.js exists with getVehicleOOSStats and getVehicleViolations methods
    - Methods query Violation model by vehicleId with company scoping
    - OOS rate calculation returns percentage (0-100)
    - BASIC breakdown included in stats response
  </done>
</task>

</tasks>

<verification>
1. Service file exists at backend/services/vehicleOOSService.js
2. Service can be required without syntax errors
3. Exports include getVehicleOOSStats and getVehicleViolations
</verification>

<success_criteria>
- vehicleOOSService.js created with ~100-150 lines
- Follows exact same module pattern as driverCSAService.js
- All methods accept companyId for tenant isolation
- Ready for route integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-integration/05-01-SUMMARY.md`
</output>
