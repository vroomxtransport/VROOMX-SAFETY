---
phase: 05-ui-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/routes/vehicles.js
  - frontend/src/utils/api.js
autonomous: true

must_haves:
  truths:
    - "GET /api/vehicles/:id/oos-stats returns OOS rate and violation stats"
    - "GET /api/vehicles/:id/violations returns paginated violations for a vehicle"
    - "Frontend vehiclesAPI has getOOSStats and getViolations methods"
  artifacts:
    - path: "backend/routes/vehicles.js"
      provides: "Vehicle OOS and violations endpoints"
      contains: "/:id/oos-stats"
    - path: "frontend/src/utils/api.js"
      provides: "Frontend API client methods"
      contains: "getOOSStats"
  key_links:
    - from: "backend/routes/vehicles.js"
      to: "backend/services/vehicleOOSService"
      via: "require and method calls"
      pattern: "vehicleOOSService\\.getVehicle"
    - from: "frontend/src/utils/api.js"
      to: "/api/vehicles/:id/oos-stats"
      via: "api.get call"
      pattern: "vehicles.*oos-stats"
---

<objective>
Add backend routes and frontend API client methods for vehicle violation/OOS data.

Purpose: Wire up vehicleOOSService to HTTP endpoints and make them accessible from React
Output: New routes in vehicles.js, new methods in api.js vehiclesAPI object
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-integration/05-01-SUMMARY.md

# Reference patterns
@backend/routes/drivers.js
@frontend/src/utils/api.js
@backend/routes/vehicles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vehicle OOS routes to vehicles.js</name>
  <files>backend/routes/vehicles.js</files>
  <action>
Add two new routes to `backend/routes/vehicles.js`:

1. At the TOP of the file (after existing requires), add:
   ```javascript
   const vehicleOOSService = require('../services/vehicleOOSService');
   ```

2. Add routes AFTER the existing `/stats` route but BEFORE `/:id` route (important: named routes must come before parameterized routes):

   **Route 1: GET /:id/oos-stats**
   ```javascript
   // @route   GET /api/vehicles/:id/oos-stats
   // @desc    Get vehicle's OOS rate and violation stats
   // @access  Private
   router.get('/:id/oos-stats', checkPermission('vehicles', 'view'), asyncHandler(async (req, res) => {
     const stats = await vehicleOOSService.getVehicleOOSStats(
       req.params.id,
       req.companyFilter.companyId
     );

     res.json({
       success: true,
       ...stats
     });
   }));
   ```

   **Route 2: GET /:id/violations**
   ```javascript
   // @route   GET /api/vehicles/:id/violations
   // @desc    Get vehicle's linked violations
   // @access  Private
   router.get('/:id/violations', checkPermission('violations', 'view'), asyncHandler(async (req, res) => {
     const { page = 1, limit = 20, basic, sortBy = 'violationDate', sortOrder = 'desc' } = req.query;

     const result = await vehicleOOSService.getVehicleViolations(
       req.params.id,
       req.companyFilter.companyId,
       { page, limit, basic, sortBy, sortOrder }
     );

     res.json({
       success: true,
       ...result
     });
   }));
   ```

IMPORTANT: These routes must be placed BEFORE the existing `router.get('/:id', ...)` route. Otherwise Express will match `:id` before `oos-stats` or `violations`.

Pattern follows exactly: drivers.js lines 186-217 (the /:id/csa and /:id/violations routes).
  </action>
  <verify>
    - Routes registered: `grep -n "oos-stats\|violations" backend/routes/vehicles.js`
    - Service imported: `grep "vehicleOOSService" backend/routes/vehicles.js`
  </verify>
  <done>
    - GET /api/vehicles/:id/oos-stats route exists
    - GET /api/vehicles/:id/violations route exists
    - Routes use vehicleOOSService methods
    - Routes placed before /:id parameterized route
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend API methods to api.js</name>
  <files>frontend/src/utils/api.js</files>
  <action>
Add two new methods to the `vehiclesAPI` object in `frontend/src/utils/api.js`:

Find the existing `vehiclesAPI` object and add these methods:

```javascript
export const vehiclesAPI = {
  // ... existing methods (getAll, getById, create, update, delete, etc.) ...

  // Safety/OOS methods (NEW - add these)
  getOOSStats: (id) => api.get(`/vehicles/${id}/oos-stats`),
  getViolations: (id, params) => api.get(`/vehicles/${id}/violations`, { params }),
};
```

Add these methods at the end of the vehiclesAPI object, before the closing brace.

Pattern follows exactly: driversAPI.getCSAImpact and driversAPI.getViolations (lines 92-93 of api.js).
  </action>
  <verify>
    - Methods exist: `grep -n "getOOSStats\|getViolations" frontend/src/utils/api.js`
    - Expected output shows both methods in vehiclesAPI section
  </verify>
  <done>
    - vehiclesAPI.getOOSStats(id) method exists
    - vehiclesAPI.getViolations(id, params) method exists
    - Methods follow existing API client pattern
  </done>
</task>

</tasks>

<verification>
1. Backend routes accessible (check syntax): `cd backend && node -e "require('./routes/vehicles')"`
2. Frontend API file valid: `cd frontend && node -e "require('./src/utils/api.js')"`
3. Routes placed before /:id in vehicles.js
</verification>

<success_criteria>
- Two new routes in vehicles.js calling vehicleOOSService
- Two new methods in vehiclesAPI object
- Route order correct (named routes before parameterized)
- Ready for frontend consumption in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-integration/05-02-SUMMARY.md`
</output>
