---
phase: 05-ui-integration
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - frontend/src/pages/VehicleDetail.jsx
autonomous: true

must_haves:
  truths:
    - "Vehicle profile page has a Safety tab in the tab navigation"
    - "Safety tab shows OOS rate percentage badge"
    - "Safety tab shows total violations, OOS violations, and OOS rate stats"
    - "Safety tab shows BASIC category breakdown"
    - "Safety tab shows recent violations list"
    - "Empty state shows 'Clean Record' when no violations linked"
  artifacts:
    - path: "frontend/src/pages/VehicleDetail.jsx"
      provides: "Vehicle Safety tab with OOS rate display"
      contains: "activeTab === 'safety'"
  key_links:
    - from: "frontend/src/pages/VehicleDetail.jsx"
      to: "vehiclesAPI.getOOSStats"
      via: "useEffect fetch on mount"
      pattern: "vehiclesAPI\\.getOOSStats"
    - from: "frontend/src/pages/VehicleDetail.jsx"
      to: "Safety tab content"
      via: "conditional render"
      pattern: "activeTab.*safety"
---

<objective>
Add Safety tab to VehicleDetail.jsx displaying OOS rate and linked violations.

Purpose: Complete VHCL-03 and VHCL-04 requirements - vehicle profile shows linked violations with OOS metrics
Output: New "Safety" tab in vehicle detail page mirroring driver Safety & CSA tab pattern
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-integration/05-02-SUMMARY.md

# Reference implementation (CRITICAL - mirror this exactly)
@frontend/src/pages/DriverDetail.jsx

# Target file
@frontend/src/pages/VehicleDetail.jsx
@frontend/src/utils/api.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Safety tab to VehicleDetail.jsx</name>
  <files>frontend/src/pages/VehicleDetail.jsx</files>
  <action>
Modify `frontend/src/pages/VehicleDetail.jsx` to add a Safety tab:

**1. Add import for FiShield icon (if not already imported):**
At the top with other react-icons imports, ensure FiShield is included:
```javascript
import {
  FiArrowLeft, FiPlus, FiTruck, FiTool, FiFileText, FiCalendar,
  FiUser, FiMapPin, FiRefreshCw, FiDroplet, FiActivity, FiEdit2,
  FiClipboard, FiAlertCircle, FiCheck, FiClock, FiSettings, FiDollarSign,
  FiShield  // ADD THIS
} from 'react-icons/fi';
```

**2. Add state for OOS data (near other useState declarations around line 108-128):**
```javascript
const [oosData, setOosData] = useState(null);
const [oosLoading, setOosLoading] = useState(true);
```

**3. Add fetchOOSData function (after fetchVehicleClaims, around line 175):**
```javascript
const fetchOOSData = async () => {
  setOosLoading(true);
  try {
    const response = await vehiclesAPI.getOOSStats(id);
    setOosData(response.data);
  } catch (error) {
    console.error('Failed to fetch OOS data:', error);
    setOosData(null);
  } finally {
    setOosLoading(false);
  }
};
```

**4. Call fetchOOSData in useEffect (around line 130-133):**
Update the existing useEffect to also call fetchOOSData:
```javascript
useEffect(() => {
  fetchVehicle();
  fetchVehicleClaims();
  fetchOOSData();  // ADD THIS
}, [id]);
```

**5. Add Safety TabButton in tab navigation (around line 445-457):**
Add between Inspections and Claims tabs:
```jsx
<TabButton
  active={activeTab === 'safety'}
  onClick={() => setActiveTab('safety')}
  icon={FiShield}
>
  Safety
  {oosData && oosData.totalViolations > 0 && (
    <span className="ml-1.5 px-1.5 py-0.5 text-xs rounded-full bg-white/20">
      {oosData.totalViolations}
    </span>
  )}
</TabButton>
```

**6. Add Safety tab content (after the claims tab content, before the modals around line 1000):**
```jsx
{activeTab === 'safety' && (
  <div className="space-y-6">
    <div className="card">
      <div className="card-header flex items-center justify-between">
        <h3 className="font-semibold flex items-center gap-2">
          <FiShield className="w-4 h-4 text-primary-500" />
          Violation History
        </h3>
        {oosData && oosData.totalViolations > 0 && (
          <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
            oosData.oosRate > 20 ? 'text-red-600 bg-red-100 dark:text-red-400 dark:bg-red-500/20' :
            oosData.oosRate > 10 ? 'text-yellow-600 bg-yellow-100 dark:text-yellow-400 dark:bg-yellow-500/20' :
            'text-green-600 bg-green-100 dark:text-green-400 dark:bg-green-500/20'
          }`}>
            {oosData.oosRate}% OOS Rate
          </span>
        )}
      </div>
      <div className="card-body">
        {oosLoading ? (
          <div className="flex justify-center py-8">
            <LoadingSpinner size="sm" />
          </div>
        ) : oosData && oosData.totalViolations > 0 ? (
          <div className="space-y-6">
            {/* Summary Stats */}
            <div className="grid grid-cols-3 gap-4">
              <div className="text-center p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl">
                <p className="text-3xl font-bold text-zinc-900 dark:text-white">{oosData.totalViolations}</p>
                <p className="text-sm text-zinc-600 dark:text-zinc-400">Violations</p>
              </div>
              <div className="text-center p-4 bg-red-50 dark:bg-red-500/10 rounded-xl">
                <p className="text-3xl font-bold text-red-600 dark:text-red-400">{oosData.oosViolations}</p>
                <p className="text-sm text-zinc-600 dark:text-zinc-400">Out of Service</p>
              </div>
              <div className="text-center p-4 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl">
                <p className="text-3xl font-bold text-zinc-900 dark:text-white">{oosData.oosRate}%</p>
                <p className="text-sm text-zinc-600 dark:text-zinc-400">OOS Rate</p>
              </div>
            </div>

            {/* BASIC Breakdown */}
            {oosData.basicBreakdown && Object.values(oosData.basicBreakdown).some(d => d.count > 0) && (
              <div>
                <p className="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400 mb-3">By Category</p>
                <div className="space-y-2">
                  {Object.entries(oosData.basicBreakdown)
                    .filter(([, data]) => data.count > 0)
                    .sort((a, b) => b[1].count - a[1].count)
                    .map(([basic, data]) => (
                      <div key={basic} className="flex items-center justify-between p-3 bg-zinc-50 dark:bg-zinc-800/50 rounded-lg">
                        <span className="text-sm text-zinc-700 dark:text-zinc-300">{data.name}</span>
                        <div className="flex items-center gap-4">
                          <span className="text-xs text-zinc-500 dark:text-zinc-400">{data.count} violations</span>
                          {data.oosCount > 0 && (
                            <span className="text-xs text-red-600 dark:text-red-400">{data.oosCount} OOS</span>
                          )}
                        </div>
                      </div>
                    ))}
                </div>
              </div>
            )}

            {/* Recent Violations */}
            {oosData.recentViolations?.length > 0 && (
              <div>
                <p className="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400 mb-3">Recent Violations</p>
                <div className="space-y-2">
                  {oosData.recentViolations.map((violation) => (
                    <div key={violation._id} className="flex items-center justify-between p-3 border border-zinc-200 dark:border-zinc-700 rounded-lg">
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-zinc-900 dark:text-white truncate">{violation.description}</p>
                        <div className="flex items-center gap-2 mt-1">
                          <span className="text-xs text-zinc-500 dark:text-zinc-400">{formatDate(violation.violationDate)}</span>
                          <span className="text-xs text-zinc-500 dark:text-zinc-400">|</span>
                          <span className="text-xs text-zinc-500 dark:text-zinc-400 capitalize">{violation.basic?.replace('_', ' ')}</span>
                          {violation.outOfService && (
                            <span className="text-xs px-1.5 py-0.5 bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400 rounded">OOS</span>
                          )}
                        </div>
                        {violation.driverId && (
                          <p className="text-xs text-zinc-500 dark:text-zinc-400 mt-1">
                            Driver: {violation.driverId.firstName} {violation.driverId.lastName}
                          </p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        ) : (
          <div className="text-center py-12">
            <div className="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-500/20 rounded-full flex items-center justify-center">
              <FiShield className="w-8 h-8 text-green-500" />
            </div>
            <h3 className="text-lg font-medium text-zinc-900 dark:text-zinc-100 mb-2">Clean Record</h3>
            <p className="text-zinc-500 dark:text-zinc-400">No violations linked to this vehicle</p>
          </div>
        )}
      </div>
    </div>
  </div>
)}
```

Key points:
- Mirror DriverDetail.jsx Safety & CSA tab structure (lines 735-840)
- Use OOS rate instead of CSA risk score
- Show driver name in violations (who was driving during inspection)
- Use same Tailwind classes for consistent styling
  </action>
  <verify>
    - FiShield imported: `grep "FiShield" frontend/src/pages/VehicleDetail.jsx`
    - Safety tab button exists: `grep "activeTab === 'safety'" frontend/src/pages/VehicleDetail.jsx`
    - OOS data fetch exists: `grep "getOOSStats" frontend/src/pages/VehicleDetail.jsx`
    - Compiles: `cd frontend && npm run build 2>&1 | head -20`
  </verify>
  <done>
    - Safety tab appears in VehicleDetail.jsx tab navigation
    - Safety tab displays OOS rate badge, stats grid, BASIC breakdown, recent violations
    - Empty state shows "Clean Record" when no violations
    - Driver name shown on violations (who was driving)
    - Styling matches DriverDetail.jsx Safety & CSA tab
  </done>
</task>

</tasks>

<verification>
1. VehicleDetail.jsx has Safety tab in navigation
2. Safety tab content renders with all sections (stats, breakdown, violations, empty state)
3. Frontend builds without errors
4. Tab order: Overview, Maintenance, Inspections, Safety, Claims
</verification>

<success_criteria>
- Safety tab visible in vehicle profile navigation
- OOS rate displayed as color-coded badge (>20% red, >10% yellow, else green)
- Stats grid shows: Total Violations, Out of Service count, OOS Rate percentage
- BASIC breakdown shows violations by category with OOS counts
- Recent violations list with driver attribution
- Empty state matches driver "Clean Record" pattern
- Requirements VHCL-03 and VHCL-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-integration/05-03-SUMMARY.md`
</output>
