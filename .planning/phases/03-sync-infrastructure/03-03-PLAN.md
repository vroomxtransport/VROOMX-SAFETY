---
phase: 03-sync-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - backend/server.js
autonomous: true

must_haves:
  truths:
    - "Background job runs every 6 hours without manual trigger"
    - "Cron job calls fmcsaSyncOrchestrator.syncAllCompanies()"
    - "Sync errors are logged to console but do not crash the server"
  artifacts:
    - path: "backend/server.js"
      provides: "FMCSA sync cron job registration"
      contains: "fmcsaSyncOrchestrator"
  key_links:
    - from: "backend/server.js"
      to: "backend/services/fmcsaSyncOrchestrator.js"
      via: "require and cron.schedule callback"
      pattern: "fmcsaSyncOrchestrator\\.syncAllCompanies"
---

<objective>
Register FMCSA sync cron job in server.js

Purpose: Automatic 6-hour sync cycle without manual intervention
Output: Cron job at `0 */6 * * *` calling fmcsaSyncOrchestrator.syncAllCompanies()
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-infrastructure/03-RESEARCH.md
@.planning/phases/03-sync-infrastructure/03-02-SUMMARY.md

# Server with existing cron patterns
@backend/server.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FMCSA sync cron job to server.js</name>
  <files>backend/server.js</files>
  <action>
Add a new cron.schedule() call for FMCSA sync inside the app.listen() callback, following the exact pattern of existing cron jobs.

1. Find the existing Samsara sync cron (around line 283-319) - add the FMCSA sync after it

2. Add this code block after the Samsara sync cron and before the final console.log:

```javascript
// Sync FMCSA data every 6 hours (CSA scores, violations, inspection stats)
cron.schedule('0 */6 * * *', async () => {
  console.log('[Cron] Running FMCSA data sync...');
  try {
    const fmcsaSyncOrchestrator = require('./services/fmcsaSyncOrchestrator');
    const result = await fmcsaSyncOrchestrator.syncAllCompanies();
    console.log(`[Cron] FMCSA sync complete: ${result.succeeded}/${result.total} companies succeeded`);
    if (result.errors.length > 0) {
      console.log(`[Cron] FMCSA sync had ${result.errors.length} company failures`);
    }
  } catch (error) {
    console.error('[Cron] FMCSA sync job failed:', error.message);
  }
});
```

3. Update the final console.log to include FMCSA sync:

Find the line (around 321):
```javascript
console.log('[Cron] Scheduled: Daily alerts at 6 AM, Alert digest emails, Escalation check every 6 hours, Trial ending check at 9 AM, Scheduled reports every hour, Samsara sync every hour');
```

Update to:
```javascript
console.log('[Cron] Scheduled: Daily alerts at 6 AM, Alert digest emails, Escalation check every 6 hours, Trial ending check at 9 AM, Scheduled reports every hour, Samsara sync every hour, FMCSA data sync every 6 hours');
```

Key points:
- Use `0 */6 * * *` to run at minute 0 of hours 0, 6, 12, 18 (same as alert escalation)
- Require orchestrator inside the callback (lazy load, matches Samsara pattern)
- Wrap everything in try/catch (never crash from cron)
- Log summary with success/fail counts
  </action>
  <verify>
1. Check cron job exists: `grep -n "FMCSA data sync" backend/server.js`
2. Check orchestrator is required: `grep -n "fmcsaSyncOrchestrator" backend/server.js`
3. Backend starts: `cd backend && timeout 5 npm run dev || true` (look for cron schedule log)
  </verify>
  <done>FMCSA sync cron job registered at 0 */6 * * * in server.js</done>
</task>

<task type="auto">
  <name>Task 2: Verify cron registration in startup logs</name>
  <files>backend/server.js</files>
  <action>
Start the backend server briefly to confirm the cron job is registered and the orchestrator loads.

```bash
cd backend && timeout 5 npm run dev 2>&1 || true
```

Look for:
1. Server startup banner
2. "[Cron] Scheduled: ... FMCSA data sync every 6 hours" in the console output
3. No require errors for fmcsaSyncOrchestrator

If any errors appear, fix them before proceeding.
  </action>
  <verify>Server starts without errors and cron schedule log includes "FMCSA data sync every 6 hours"</verify>
  <done>Cron job is registered and server starts successfully</done>
</task>

</tasks>

<verification>
1. Cron pattern in server.js: `grep "0 \*/6" backend/server.js`
2. Orchestrator called: `grep "syncAllCompanies" backend/server.js`
3. Error handling present: `grep -A5 "FMCSA data sync" backend/server.js | grep "catch"`
4. Startup log updated: `grep "FMCSA data sync every 6 hours" backend/server.js`
5. Backend starts cleanly: `cd backend && timeout 5 npm run dev 2>&1 | head -20`
</verification>

<success_criteria>
- Cron job registered with `0 */6 * * *` schedule
- Cron callback calls fmcsaSyncOrchestrator.syncAllCompanies()
- All errors caught and logged (no crash risk)
- Startup log confirms FMCSA sync scheduled
- Backend server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-infrastructure/03-03-SUMMARY.md`
</output>
