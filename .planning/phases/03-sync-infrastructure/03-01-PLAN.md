---
phase: 03-sync-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/models/Company.js
autonomous: true

must_haves:
  truths:
    - "Company record can store last sync time"
    - "Company record can store success/failure status"
    - "Company record can store sync errors per data source"
  artifacts:
    - path: "backend/models/Company.js"
      provides: "syncStatus schema in fmcsaData"
      contains: "syncStatus"
  key_links:
    - from: "backend/models/Company.js"
      to: "fmcsaData.syncStatus"
      via: "nested schema object"
      pattern: "syncStatus.*lastRun"
---

<objective>
Add sync status tracking schema to Company model

Purpose: Enable per-company sync status visibility (last run, success/failure, errors by data source)
Output: Extended Company.fmcsaData with syncStatus object for Phase 3 orchestrator to write to
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sync-infrastructure/03-RESEARCH.md

# Existing Company model structure
@backend/models/Company.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add syncStatus schema to Company.fmcsaData</name>
  <files>backend/models/Company.js</files>
  <action>
Add a `syncStatus` nested object inside the existing `fmcsaData` schema with these fields:

```javascript
syncStatus: {
  lastRun: { type: Date },
  success: { type: Boolean },
  errors: [{
    source: { type: String, enum: ['csa_scores', 'violations', 'inspections'] },
    error: String,
    timestamp: { type: Date, default: Date.now }
  }],
  // Track each data source independently
  csaScoresLastSync: { type: Date },
  violationsLastSync: { type: Date },
  inspectionsLastSync: { type: Date }
}
```

Place this after the existing `dataSource` field inside `fmcsaData` (around line 132).

Why these fields:
- `lastRun`: When the orchestrator last attempted a sync
- `success`: True only if ALL sources succeeded
- `errors`: Array of per-source errors (empty on full success)
- Per-source timestamps: Allow partial success tracking (CSA might succeed while violations fail)
  </action>
  <verify>
Run: `node -e "const Company = require('./backend/models/Company'); const schema = Company.schema.obj.fmcsaData.syncStatus; console.log('lastRun:', !!schema.lastRun); console.log('success:', !!schema.success); console.log('errors:', !!schema.errors); console.log('csaScoresLastSync:', !!schema.csaScoresLastSync);"`

Should output all true values.
  </verify>
  <done>Company model has syncStatus schema with lastRun, success, errors array, and per-source timestamps</done>
</task>

</tasks>

<verification>
1. Company model loads without errors: `node -e "require('./backend/models/Company')"`
2. syncStatus fields accessible: `node -e "const C = require('./backend/models/Company'); console.log(JSON.stringify(C.schema.obj.fmcsaData.syncStatus, null, 2))"`
3. Backend starts: `cd backend && npm run dev` (check no schema errors in console)
</verification>

<success_criteria>
- Company.fmcsaData.syncStatus schema exists with all required fields
- Backend server starts without Mongoose schema errors
- Fields match research specification (lastRun, success, errors, per-source timestamps)
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-infrastructure/03-01-SUMMARY.md`
</output>
