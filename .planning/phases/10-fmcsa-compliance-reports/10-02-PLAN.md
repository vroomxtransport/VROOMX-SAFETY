---
phase: 10-fmcsa-compliance-reports
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/routes/reports.js
  - frontend/src/utils/api.js
  - frontend/src/pages/Reports.jsx
  - frontend/src/utils/reportFilterConfig.js
autonomous: true

must_haves:
  truths:
    - "User can generate Document Expiration Report showing items expiring in 30/60/90 days"
    - "Document Expiration Report groups documents by expiration window (expired, 30 days, 60 days, 90 days)"
    - "User can generate Drug & Alcohol Summary Report"
    - "Drug & Alcohol Report shows random pool percentages (50% drug, 10% alcohol compliance)"
    - "Drug & Alcohol Report shows testing compliance status"
  artifacts:
    - path: "backend/routes/reports.js"
      provides: "Document expiration and Drug & Alcohol report endpoints"
      contains: "document-expiration"
    - path: "frontend/src/utils/api.js"
      provides: "API methods for new report types"
      contains: "getDocumentExpirationReport"
    - path: "frontend/src/pages/Reports.jsx"
      provides: "Report cards for new report types"
      contains: "Document Expiration"
  key_links:
    - from: "backend/routes/reports.js"
      to: "Document model"
      via: "expiration date query with window grouping"
      pattern: "expiryDate.*\\$lte.*ninetyDays"
    - from: "backend/routes/reports.js"
      to: "DrugAlcoholTest model"
      via: "test type and date aggregation"
      pattern: "testType.*random"
    - from: "frontend/src/pages/Reports.jsx"
      to: "reportsAPI"
      via: "API method calls"
      pattern: "getDocumentExpirationReport|getDrugAlcoholReport"
---

<objective>
Create two new FMCSA compliance report endpoints: Document Expiration Report (showing documents expiring within 30/60/90 days grouped by window) and Drug & Alcohol Summary Report (showing testing compliance with random pool percentage calculations against FMCSA 50%/10% requirements).

Purpose: Safety managers need to track upcoming document expirations proactively and demonstrate drug/alcohol testing compliance during audits.
Output: Two new report endpoints with full JSON/CSV/Excel/PDF support and frontend integration.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fmcsa-compliance-reports/10-RESEARCH.md
@backend/routes/reports.js
@backend/models/Document.js
@backend/models/DrugAlcoholTest.js
@backend/models/Driver.js
@backend/utils/pdfGenerator.js
@backend/services/exportService.js
@frontend/src/utils/api.js
@frontend/src/pages/Reports.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Document Expiration Report endpoint</name>
  <files>backend/routes/reports.js</files>
  <action>
Add new endpoint GET /api/reports/document-expiration after the existing /dqf endpoint:

1. Import addDays from date-fns at the top if not already imported
2. Create endpoint with standard middleware: checkPermission('reports', 'view')
3. Query parameters: format (default 'json'), driverIds, vehicleIds
4. Implementation:
   ```javascript
   const now = new Date();
   const thirtyDays = addDays(now, 30);
   const sixtyDays = addDays(now, 60);
   const ninetyDays = addDays(now, 90);

   const query = {
     companyId,
     isDeleted: false,
     expiryDate: { $exists: true, $lte: ninetyDays }
   };

   // Apply optional driver/vehicle filters
   if (driverIds) {
     const ids = driverIds.split(',').filter(Boolean);
     if (ids.length > 0) query.driverId = { $in: ids };
   }
   if (vehicleIds) {
     const ids = vehicleIds.split(',').filter(Boolean);
     if (ids.length > 0) query.vehicleId = { $in: ids };
   }

   const documents = await Document.find(query)
     .populate('driverId', 'firstName lastName')
     .populate('vehicleId', 'unitNumber')
     .sort('expiryDate')
     .lean();
   ```

5. Group documents by window using EXCLUSIVE ranges:
   - expired: expiryDate < now
   - within30Days: expiryDate >= now AND expiryDate <= thirtyDays
   - within60Days: expiryDate > thirtyDays AND expiryDate <= sixtyDays
   - within90Days: expiryDate > sixtyDays AND expiryDate <= ninetyDays

6. JSON response structure:
   ```javascript
   {
     success: true,
     report: {
       type: 'Document Expiration Report',
       generatedAt: new Date(),
       company: { name, dotNumber },
       summary: {
         expired: expired.length,
         within30Days: within30Days.length,
         within60Days: within60Days.length,
         within90Days: within90Days.length,
         total: documents.length
       },
       documents: {
         expired: [...mapped docs],
         within30Days: [...],
         within60Days: [...],
         within90Days: [...]
       }
     }
   }
   ```

7. Each mapped document includes: documentType, category, name, expiryDate, driverName (if linked), vehicleUnit (if linked)

8. CSV export: Flatten all documents with window column, sorted by expiry date
9. Excel export: Same structure with columns: Window, Document Type, Name, Expiry Date, Driver, Vehicle
10. PDF export:
    - Header using pdf.addHeader
    - Summary box with 4 counts
    - Four sections (Expired, Within 30 Days, Within 60 Days, Within 90 Days)
    - Table per section with document details
    - Use pdf.COLORS.primary for section titles, highlight expired in red

IMPORTANT: Use existing pattern from violations report for multi-select filters.
  </action>
  <verify>
    - curl -X GET "http://localhost:5001/api/reports/document-expiration?format=json" with valid auth returns grouped document data
    - Documents appear in exactly one window (no duplicates)
    - Sum of window counts equals total count
  </verify>
  <done>
    - GET /api/reports/document-expiration endpoint returns documents grouped by expiration window
    - Supports JSON, CSV, Excel, PDF formats
    - Supports optional driverIds, vehicleIds filters
    - Documents appear in mutually exclusive windows
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Drug & Alcohol Summary Report endpoint</name>
  <files>backend/routes/reports.js</files>
  <action>
Add new endpoint GET /api/reports/drug-alcohol-summary after document-expiration:

1. Import startOfYear from date-fns if not already imported
2. Create endpoint with checkPermission('reports', 'view')
3. Query parameters: format (default 'json'), startDate, endDate (default to current year)
4. Implementation:
   ```javascript
   // Default to calendar year for random testing compliance
   const yearStart = startDate ? new Date(startDate) : startOfYear(new Date());
   const yearEnd = endDate ? new Date(endDate) : new Date();

   const [activeDrivers, tests] = await Promise.all([
     Driver.countDocuments({ companyId, status: 'active' }),
     DrugAlcoholTest.find({
       companyId,
       testDate: { $gte: yearStart, $lte: yearEnd }
     }).populate('driverId', 'firstName lastName').lean()
   ]);
   ```

5. Calculate random test compliance:
   ```javascript
   const randomDrugTests = tests.filter(t =>
     t.testType === 'random' && t.drugTest?.performed
   );
   const randomAlcoholTests = tests.filter(t =>
     t.testType === 'random' && t.alcoholTest?.performed
   );

   // FMCSA 2026 requirements: 50% drug, 10% alcohol
   const requiredDrugTests = Math.ceil(activeDrivers * 0.50);
   const requiredAlcoholTests = Math.ceil(activeDrivers * 0.10);

   const drugCompliancePercent = requiredDrugTests > 0
     ? Math.round((randomDrugTests.length / requiredDrugTests) * 100)
     : 100; // No drivers = compliant
   const alcoholCompliancePercent = requiredAlcoholTests > 0
     ? Math.round((randomAlcoholTests.length / requiredAlcoholTests) * 100)
     : 100;
   ```

6. Group tests by type for breakdown:
   ```javascript
   const byType = tests.reduce((acc, t) => {
     acc[t.testType] = acc[t.testType] || { total: 0, negative: 0, positive: 0, pending: 0 };
     acc[t.testType].total++;
     acc[t.testType][t.overallResult]++;
     return acc;
   }, {});
   ```

7. JSON response structure with summary and breakdown
8. CSV export: Two sections - summary metrics as rows, then test details
9. Excel export: Summary sheet with compliance metrics
10. PDF export:
    - Summary box: Active Drivers, Random Drug %, Random Alcohol %
    - Compliance status boxes (green if >= 100%, red if < 100%)
    - Table: Tests by Type with counts
    - Table: Recent tests list (last 20)

IMPORTANT: Guard against division by zero. If no active drivers, compliance is 100%.
  </action>
  <verify>
    - curl -X GET "http://localhost:5001/api/reports/drug-alcohol-summary?format=json" returns compliance percentages
    - drugCompliancePercent and alcoholCompliancePercent are numbers, not NaN or Infinity
    - Report shows required vs completed random tests
  </verify>
  <done>
    - GET /api/reports/drug-alcohol-summary endpoint returns testing compliance data
    - Shows random pool percentages against 50%/10% requirements
    - Supports date range filtering (defaults to current year)
    - Supports JSON, CSV, Excel, PDF formats
  </done>
</task>

<task type="auto">
  <name>Task 3: Add frontend integration for new reports</name>
  <files>frontend/src/utils/api.js, frontend/src/pages/Reports.jsx, frontend/src/utils/reportFilterConfig.js</files>
  <action>
1. In frontend/src/utils/api.js, add to reportsAPI object (after existing methods):
   ```javascript
   getDocumentExpirationReport: (params) => api.get('/reports/document-expiration', {
     params: {
       ...params,
       driverIds: params.driverIds?.length ? params.driverIds.join(',') : undefined,
       vehicleIds: params.vehicleIds?.length ? params.vehicleIds.join(',') : undefined
     },
     responseType: ['pdf', 'csv', 'xlsx'].includes(params.format) ? 'blob' : 'json',
     ...(['pdf', 'csv', 'xlsx'].includes(params.format) && { timeout: 300000 })
   }),
   getDrugAlcoholReport: (params) => api.get('/reports/drug-alcohol-summary', {
     params,
     responseType: ['pdf', 'csv', 'xlsx'].includes(params.format) ? 'blob' : 'json',
     ...(['pdf', 'csv', 'xlsx'].includes(params.format) && { timeout: 300000 })
   }),
   ```

2. In frontend/src/pages/Reports.jsx, add two new report cards to the reports array:
   ```javascript
   {
     id: 'document-expiration',
     title: 'Document Expiration Report',
     description: 'Documents expiring within 30, 60, or 90 days grouped by urgency window.',
     icon: FiFileText, // Already imported
     color: 'yellow',
     api: reportsAPI.getDocumentExpirationReport
   },
   {
     id: 'drug-alcohol',
     title: 'Drug & Alcohol Summary',
     description: 'Testing compliance status with random pool percentages (50% drug, 10% alcohol).',
     icon: FiClipboard, // Or use a different icon if preferred
     color: 'purple',
     api: reportsAPI.getDrugAlcoholReport
   }
   ```

3. In frontend/src/utils/reportFilterConfig.js, add configurations:
   ```javascript
   'document-expiration': {
     enableDateRange: false, // Uses fixed windows, not date range
     enableDriverFilter: true,
     enableVehicleFilter: true,
     enableStatusFilter: false
   },
   'drug-alcohol': {
     enableDateRange: true, // Allows specifying reporting period
     enableDriverFilter: false,
     enableVehicleFilter: false,
     enableStatusFilter: false
   }
   ```
  </action>
  <verify>
    - npm run dev in frontend starts without errors
    - Reports page shows 6 report cards (4 existing + 2 new)
    - Document Expiration card shows yellow color, description mentions 30/60/90 days
    - Drug & Alcohol card shows purple color, description mentions 50%/10%
  </verify>
  <done>
    - Document Expiration Report card visible on Reports page
    - Drug & Alcohol Summary card visible on Reports page
    - Filter configuration appropriate for each report type
    - Download functionality works for all formats
  </done>
</task>

</tasks>

<verification>
1. Backend: Test both new endpoints with curl for all 4 formats
2. Frontend: Generate Document Expiration PDF - verify 4 sections appear
3. Frontend: Generate Drug & Alcohol PDF - verify compliance percentages shown
4. Edge case: Test D&A report with no active drivers - should not show NaN/Infinity
</verification>

<success_criteria>
- User can generate Document Expiration Report (FMCS-05)
- Document Expiration shows items grouped by 30/60/90 day windows
- User can generate Drug & Alcohol Summary Report (FMCS-06)
- D&A Report shows random pool compliance (50% drug, 10% alcohol) (FMCS-07)
- Both reports work in JSON, CSV, Excel, PDF formats
- Both reports show DOT number and timestamp in header (FMCS-08 - inherited from pdfGenerator)
</success_criteria>

<output>
After completion, create `.planning/phases/10-fmcsa-compliance-reports/10-02-SUMMARY.md`
</output>
