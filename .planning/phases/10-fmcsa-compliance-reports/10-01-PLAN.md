---
phase: 10-fmcsa-compliance-reports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/routes/reports.js
  - frontend/src/utils/api.js
  - frontend/src/pages/Reports.jsx
  - frontend/src/utils/reportFilterConfig.js
autonomous: true

must_haves:
  truths:
    - "DQF report shows Clearinghouse query date for each driver"
    - "DQF report shows MVR review date for each driver"
    - "DQF report shows safety performance history investigation status"
    - "DQF report shows employment application verification status"
    - "DQF PDF/CSV/Excel exports include all 391.51 compliance fields"
  artifacts:
    - path: "backend/routes/reports.js"
      provides: "Extended DQF endpoint with 391.51 fields"
      contains: "clearinghouseQueryDate"
    - path: "frontend/src/pages/Reports.jsx"
      provides: "Updated DQF report description"
      contains: "49 CFR 391.51"
  key_links:
    - from: "backend/routes/reports.js"
      to: "Driver.clearinghouse"
      via: "driver query with nested field selection"
      pattern: "clearinghouse.*lastQueryDate"
    - from: "backend/routes/reports.js"
      to: "Driver.documents.mvrReviews"
      via: "nested document field access"
      pattern: "documents.*mvrReviews"
---

<objective>
Extend the existing DQF report endpoint to include all 49 CFR 391.51 required compliance fields per driver: Clearinghouse query date, MVR review date, safety performance history status, and employment application status.

Purpose: DOT auditors require these specific fields for DQF compliance verification. The Driver model already captures this data - we just need to surface it in the report output.
Output: Enhanced DQF endpoint returning full 391.51 compliance data in JSON/CSV/Excel/PDF formats.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fmcsa-compliance-reports/10-RESEARCH.md
@backend/routes/reports.js
@backend/models/Driver.js
@backend/utils/pdfGenerator.js
@frontend/src/utils/api.js
@frontend/src/pages/Reports.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend DQF endpoint with 391.51 compliance fields</name>
  <files>backend/routes/reports.js</files>
  <action>
Modify the GET /api/reports/dqf endpoint to include additional 391.51 fields:

1. In the JSON response section, extend the driver mapping to include:
   - clearinghouseQueryDate: d.clearinghouse?.lastQueryDate
   - clearinghouseQueryType: d.clearinghouse?.queryType (full/limited)
   - clearinghouseStatus: d.clearinghouse?.status
   - mvrReviewDate: d.documents?.mvrReviews?.[0]?.reviewDate (most recent)
   - mvrReviewerName: d.documents?.mvrReviews?.[0]?.reviewerName
   - mvrApproved: d.documents?.mvrReviews?.[0]?.approved
   - employmentVerificationStatus: Calculate from d.documents?.employmentVerification array
     - 'complete' if at least one verified entry exists
     - 'pending' if entries exist but none verified
     - 'missing' if no entries
   - employmentApplicationReceived: d.documents?.employmentApplication?.dateReceived
   - employmentApplicationComplete: d.documents?.employmentApplication?.complete
   - roadTestDate: d.documents?.roadTest?.date
   - roadTestResult: d.documents?.roadTest?.result
   - roadTestWaived: d.documents?.roadTest?.waived

2. In the CSV export section, add these columns:
   - clearinghouseQueryDate (formatted date)
   - clearinghouseStatus
   - mvrReviewDate (formatted date)
   - employmentVerificationStatus

3. In the Excel export section, add matching columns with appropriate widths:
   - clearinghouseQueryDate: 18
   - clearinghouseStatus: 15
   - mvrReviewDate: 18
   - employmentVerificationStatus: 20

4. In the PDF export section, add a new "391.51 Compliance" section per driver:
   - Add a second pdf.addKeyValuePairs block after the existing driver details
   - Include: Clearinghouse Query Date, Query Type, MVR Review Date, Employment Verification Status, Application Status

5. Use existing helpers: pdf.formatDate() for dates, || '-' for null handling

IMPORTANT: Do NOT change the existing field names or break backward compatibility - ADD these as additional fields.
  </action>
  <verify>
    - curl -X GET "http://localhost:5001/api/reports/dqf?format=json" with valid auth should return JSON with clearinghouseQueryDate, mvrReviewDate, and employmentVerificationStatus fields in each driver object
    - Response structure validated: drivers[0] has all new fields (even if values are null/--)
  </verify>
  <done>
    - DQF JSON response includes all 391.51 compliance fields per driver
    - DQF CSV export includes 4 new columns
    - DQF Excel export includes 4 new columns with proper widths
    - DQF PDF includes "391.51 Compliance" section per driver
  </done>
</task>

<task type="auto">
  <name>Task 2: Update frontend API and Reports page for enhanced DQF</name>
  <files>frontend/src/utils/api.js, frontend/src/pages/Reports.jsx, frontend/src/utils/reportFilterConfig.js</files>
  <action>
1. In frontend/src/pages/Reports.jsx, update the DQF report card:
   - Change description to: "Complete DQ file status report with 49 CFR 391.51 compliance fields including Clearinghouse, MVR, and employment verification status."

2. No changes needed to api.js - the existing getDqfReport method will receive the enhanced response automatically.

3. Verify reportFilterConfig.js has dqf entry with enableDateRange, enableDriverFilter, enableStatusFilter as appropriate (should already exist from Phase 9).
  </action>
  <verify>
    - npm run dev in frontend folder starts without errors
    - Reports page shows updated DQF description text
  </verify>
  <done>
    - DQF report card description mentions 391.51 compliance and Clearinghouse
    - Frontend properly receives enhanced DQF data without code changes
  </done>
</task>

</tasks>

<verification>
1. Backend test: Generate DQF report in all formats and verify new fields appear
2. Visual test: Open Reports page, select DQF, download PDF - confirm 391.51 section visible
3. Data test: If test driver has Clearinghouse data, verify dates appear correctly formatted
</verification>

<success_criteria>
- DQF report shows Clearinghouse query date per driver (FMCS-01)
- DQF report shows MVR review date per driver (FMCS-02)
- DQF report shows safety performance history status (FMCS-03)
- DQF report shows employment application status (FMCS-04)
- All export formats (JSON, CSV, Excel, PDF) include the new fields
- Existing DQF functionality unchanged (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/10-fmcsa-compliance-reports/10-01-SUMMARY.md`
</output>
