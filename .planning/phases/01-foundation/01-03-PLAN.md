---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/server.js
  - backend/.env.example
autonomous: true

must_haves:
  truths:
    - "Server startup fails with clear error if SAFERWEB_API_KEY is missing in production"
    - "Server startup fails with clear error if SOCRATA_APP_TOKEN is missing in production"
    - "Environment variable documentation includes all FMCSA-related vars with descriptions"
  artifacts:
    - path: "backend/server.js"
      provides: "FMCSA env var validation at startup"
      contains: "SAFERWEB_API_KEY"
    - path: "backend/.env.example"
      provides: "Documentation for FMCSA environment variables"
      contains: "SOCRATA_APP_TOKEN"
  key_links:
    - from: "backend/server.js"
      to: "process.env"
      via: "startup validation"
      pattern: "SAFERWEB_API_KEY.*SOCRATA_APP_TOKEN"
---

<objective>
Add FMCSA API environment variables to startup validation and document all FMCSA-related vars in .env.example.

Purpose: Ensure the server fails fast with a clear error message if required FMCSA API credentials are missing in production, preventing silent failures during sync attempts.

Output: Updated server.js with FMCSA env var validation, and updated .env.example with comprehensive FMCSA documentation.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/server.js
@backend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FMCSA env vars to production validation in server.js</name>
  <files>backend/server.js</files>
  <action>
Modify the production environment variable validation block (around line 27-38) to include FMCSA API credentials.

Add SAFERWEB_API_KEY and SOCRATA_APP_TOKEN to the productionEnvVars array:

```javascript
// In production, also validate service-specific env vars
if (process.env.NODE_ENV === 'production') {
  const productionEnvVars = [
    'STRIPE_SECRET_KEY', 'STRIPE_WEBHOOK_SECRET',
    'STRIPE_SOLO_PRICE_ID', 'STRIPE_FLEET_PRICE_ID', 'STRIPE_PRO_PRICE_ID',
    'RESEND_API_KEY', 'FRONTEND_URL',
    // FMCSA Data Sync (Phase 3)
    'SAFERWEB_API_KEY',      // SaferWebAPI for inspection details
    'SOCRATA_APP_TOKEN'      // DataHub API for violations (1000 req/hr)
  ];
  const missingProdVars = productionEnvVars.filter(v => !process.env[v]);
  if (missingProdVars.length > 0) {
    console.error(`FATAL: Missing production environment variables: ${missingProdVars.join(', ')}`);
    process.exit(1);
  }
}
```

Also add a warning for missing FMCSA vars in development (after the JWT_SECRET warning, around line 43):

```javascript
// Warn about missing FMCSA credentials in development
if (process.env.NODE_ENV !== 'production') {
  const fmcsaVars = ['SAFERWEB_API_KEY', 'SOCRATA_APP_TOKEN'];
  const missingFmcsa = fmcsaVars.filter(v => !process.env[v]);
  if (missingFmcsa.length > 0) {
    console.warn(`WARNING: Missing FMCSA credentials (${missingFmcsa.join(', ')}). FMCSA sync will not work.`);
  }
}
```
  </action>
  <verify>
Test 1 - Check code compiles: `node -c backend/server.js`

Test 2 - Verify vars are in the array:
`grep -E "SAFERWEB_API_KEY|SOCRATA_APP_TOKEN" backend/server.js | wc -l`
Expected: At least 4 occurrences (2 in productionEnvVars, 2 in fmcsaVars)
  </verify>
  <done>
server.js validates SAFERWEB_API_KEY and SOCRATA_APP_TOKEN in production (fails startup if missing), and warns about missing FMCSA credentials in development.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document all FMCSA environment variables in .env.example</name>
  <files>backend/.env.example</files>
  <action>
Update the FMCSA section in .env.example (currently around lines 39-45) to be comprehensive. Replace the existing FMCSA section with:

```env
# =============================================================================
# FMCSA Data Sync Configuration
# =============================================================================
# These credentials are REQUIRED in production for automatic FMCSA data sync.
# In development, sync features will be disabled if not configured.

# SaferWebAPI - For inspection details and carrier profile data
# Get your API key at: https://saferweb.org (registration required)
# Used by: fmcsaSyncService for inspection details
SAFERWEB_API_KEY=your-saferweb-api-key

# Socrata DataHub API - For violation data from FMCSA public datasets
# Get your app token at: https://opendata.transportation.gov
# Rate limit: 1000 requests/hour with token, much lower without
# Used by: dataHubService for violation records
SOCRATA_APP_TOKEN=your-socrata-app-token

# FMCSA SAFER API (optional) - For carrier snapshot data
# Public API, key improves rate limits but not strictly required
# Get your key at: https://mobile.fmcsa.dot.gov/qc/services
FMCSA_API_KEY=your-fmcsa-api-key
FMCSA_API_BASE_URL=https://mobile.fmcsa.dot.gov/qc/services
```

Remove any duplicate FMCSA entries that may exist elsewhere in the file.
  </action>
  <verify>
Check all required FMCSA vars are documented:
`grep -E "^(SAFERWEB_API_KEY|SOCRATA_APP_TOKEN|FMCSA_API_KEY)=" backend/.env.example | wc -l`
Expected: 3 lines

Check documentation comments exist:
`grep -c "SaferWebAPI\|Socrata\|DataHub" backend/.env.example`
Expected: At least 2 occurrences
  </verify>
  <done>
.env.example contains documented entries for SAFERWEB_API_KEY, SOCRATA_APP_TOKEN, and FMCSA_API_KEY with descriptions of what each is used for, where to obtain credentials, and rate limit information.
  </done>
</task>

</tasks>

<verification>
1. server.js syntax valid: `node -c backend/server.js`
2. SAFERWEB_API_KEY in production validation
3. SOCRATA_APP_TOKEN in production validation
4. Development warning for missing FMCSA vars
5. .env.example documents all three FMCSA env vars with descriptions
6. Backend starts in dev mode (warning expected): `cd backend && timeout 5 npm run dev || true`
</verification>

<success_criteria>
- server.js includes SAFERWEB_API_KEY and SOCRATA_APP_TOKEN in production validation (process.exit(1) if missing)
- server.js warns about missing FMCSA credentials in development
- .env.example documents SAFERWEB_API_KEY with usage description and how to obtain
- .env.example documents SOCRATA_APP_TOKEN with rate limit info and how to obtain
- .env.example documents FMCSA_API_KEY as optional with description
- Backend starts successfully (warnings expected for missing FMCSA vars)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
