---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/models/FMCSAInspection.js
autonomous: true

must_haves:
  truths:
    - "FMCSAInspection model can reference Violation documents via violationRefs array"
    - "Existing violations[] array is marked as deprecated but NOT removed"
    - "Code comments explain the migration path from embedded to referenced violations"
  artifacts:
    - path: "backend/models/FMCSAInspection.js"
      provides: "Reference array to Violation documents"
      contains: "violationRefs"
    - path: "backend/models/FMCSAInspection.js"
      provides: "Deprecation notice on embedded violations"
      contains: "@deprecated"
  key_links:
    - from: "backend/models/FMCSAInspection.js"
      to: "backend/models/Violation.js"
      via: "ObjectId reference in violationRefs"
      pattern: "ref.*Violation"
---

<objective>
Add violationRefs array to FMCSAInspection model for referencing Violation documents, while preserving the existing embedded violations[] array with deprecation notices.

Purpose: Enable FMCSAInspection to reference violations in the Violation collection (SSOT) rather than storing duplicates. The embedded array is kept for Phase 2 migration but marked deprecated.

Output: Updated FMCSAInspection.js with violationRefs[] array and JSDoc deprecation notices.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/models/FMCSAInspection.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add violationRefs array and deprecation notices</name>
  <files>backend/models/FMCSAInspection.js</files>
  <action>
Modify the FMCSAInspection schema:

1. **Add deprecation comment above violations[] array** (around line 62):
```javascript
  /**
   * @deprecated Use violationRefs[] instead. This embedded array will be removed after Phase 2 migration.
   * Violations should be stored in the Violation collection and referenced here.
   * Migration: Phase 2 will extract these to Violation documents and populate violationRefs.
   */
  violations: [{
    // ... existing fields unchanged ...
  }],
```

2. **Add violationRefs array** after the violations array (around line 83):
```javascript
  // References to Violation documents (SSOT)
  // Populated after Phase 2 migration extracts embedded violations
  violationRefs: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Violation'
  }],
```

3. **Add index for violationRefs lookups** after existing indexes (around line 113):
```javascript
// Index for finding inspections by linked violations
fmcsaInspectionSchema.index({ violationRefs: 1 });
```

4. **Update the file's top-level JSDoc comment** to mention the migration status:
```javascript
/**
 * FMCSA Inspection Model
 * Stores inspection records imported from FMCSA SMS system
 *
 * NOTE: This model is transitioning from embedded violations to referenced violations.
 * - violations[] (DEPRECATED): Legacy embedded array, kept for migration
 * - violationRefs[]: References to Violation documents (SSOT)
 * See Phase 2 migration plan for details.
 */
```
  </action>
  <verify>
Run: `node -e "const I = require('./backend/models/FMCSAInspection'); console.log('violationRefs:', I.schema.path('violationRefs') ? 'EXISTS' : 'MISSING'); console.log('violations:', I.schema.path('violations') ? 'EXISTS' : 'MISSING')"`

Expected output:
```
violationRefs: EXISTS
violations: EXISTS
```
  </verify>
  <done>
FMCSAInspection model has violationRefs[] array referencing Violation documents, violations[] array is preserved with @deprecated JSDoc tag, and file-level comment explains the migration status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add virtual for getting violations from either source</name>
  <files>backend/models/FMCSAInspection.js</files>
  <action>
Add a helper virtual that provides violations from whichever source is populated. This helps code work during the transition period. Add after the existing virtuals (around line 128):

```javascript
/**
 * Virtual that returns violation count from either source.
 * During migration: prefers violationRefs if populated, falls back to embedded.
 * After migration: violationRefs will always be used.
 */
fmcsaInspectionSchema.virtual('violationCount').get(function() {
  if (this.violationRefs && this.violationRefs.length > 0) {
    return this.violationRefs.length;
  }
  return this.violations?.length || 0;
});

/**
 * Virtual that indicates whether this inspection has been migrated.
 * True if violationRefs is populated, false if still using embedded violations.
 */
fmcsaInspectionSchema.virtual('isMigrated').get(function() {
  return this.violationRefs && this.violationRefs.length > 0;
});
```
  </action>
  <verify>
Run: `node -e "const I = require('./backend/models/FMCSAInspection'); const doc = new I({ companyId: '507f1f77bcf86cd799439011', reportNumber: 'TEST', inspectionDate: new Date() }); console.log('violationCount:', doc.violationCount); console.log('isMigrated:', doc.isMigrated)"`

Expected output:
```
violationCount: 0
isMigrated: false
```
  </verify>
  <done>
FMCSAInspection model has violationCount and isMigrated virtuals that help code work during the transition period from embedded to referenced violations.
  </done>
</task>

</tasks>

<verification>
1. Schema loads without errors: `node -e "require('./backend/models/FMCSAInspection')"`
2. violationRefs field exists and references Violation model
3. violations[] field still exists (not removed)
4. Deprecation comment present in source code
5. Backend starts: `cd backend && npm run dev` starts without errors
</verification>

<success_criteria>
- FMCSAInspection.js contains violationRefs[] array with ObjectId references to Violation
- violations[] array is preserved with @deprecated JSDoc comment
- File-level comment explains the embedded-to-referenced transition
- violationCount and isMigrated virtuals work correctly
- Backend server starts successfully with updated model
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
