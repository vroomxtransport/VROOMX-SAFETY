---
phase: 12-report-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/models/ReportHistory.js
  - backend/services/reportHistoryService.js
  - backend/routes/reportHistory.js
  - backend/routes/index.js
autonomous: true

must_haves:
  truths:
    - "ReportHistory model stores generation metadata with 90-day TTL"
    - "Service can save report files to disk with company isolation"
    - "API endpoint returns paginated list of history records"
    - "API endpoint serves authenticated file downloads"
  artifacts:
    - path: "backend/models/ReportHistory.js"
      provides: "ReportHistory schema with TTL index"
      contains: "expireAfterSeconds"
    - path: "backend/services/reportHistoryService.js"
      provides: "File storage and cleanup operations"
      exports: ["saveReport", "ensureDir"]
    - path: "backend/routes/reportHistory.js"
      provides: "List and download endpoints"
      contains: "/download"
  key_links:
    - from: "backend/routes/reportHistory.js"
      to: "backend/models/ReportHistory.js"
      via: "require('../models/ReportHistory')"
      pattern: "ReportHistory\\.find"
    - from: "backend/routes/index.js"
      to: "backend/routes/reportHistory.js"
      via: "router.use('/report-history'"
      pattern: "report-history"
---

<objective>
Create the ReportHistory model, service, and API routes for tracking and re-downloading generated reports.

Purpose: Establish the backend infrastructure for report history tracking (HIST-01, HIST-03)
Output: Model with TTL index, file management service, list/download API endpoints
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-report-history/12-RESEARCH.md

# Existing patterns to follow
@backend/models/AuditLog.js
@backend/routes/documents.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReportHistory model with TTL index</name>
  <files>backend/models/ReportHistory.js</files>
  <action>
Create ReportHistory model following AuditLog TTL pattern:

Schema fields:
- companyId: ObjectId ref Company, required, indexed
- generatedBy: ObjectId ref User, required
- generatedByEmail: String, required (denormalized for display without join)
- reportType: String, required, enum for all 9 report types (dqf, vehicle, violations, audit, document-expiration, drug-alcohol, dataq-history, accident-summary, maintenance-costs), indexed
- reportName: String, required (human-readable name like "Driver Qualification Files")
- format: String, required, enum ['csv', 'xlsx']
- filters: Mixed object storing filter params (startDate, endDate, driverIds, vehicleIds, status)
- selectedFields: [String] array of field keys used
- templateId: ObjectId ref ReportTemplate, optional
- templateName: String, optional (denormalized)
- filePath: String, required (absolute path to file)
- fileName: String, required (filename for download header)
- fileSize: Number, required (bytes)
- rowCount: Number, optional (record count in report)
- generatedAt: Date, default Date.now, indexed
- expiresAt: Date, required, indexed

Indexes:
- TTL index on expiresAt with expireAfterSeconds: 0 (MongoDB uses field value)
- Compound: { companyId: 1, generatedAt: -1 }
- Compound: { companyId: 1, reportType: 1, generatedAt: -1 }

Static methods:
- RETENTION_DAYS = 90
- calculateExpiresAt() returns Date 90 days from now

Pre-save hook: Set expiresAt if not already set

Virtuals (with toJSON/toObject enabled):
- fileSizeFormatted: returns "X.X KB" or "X.X MB"
- daysUntilExpiry: returns number of days until expiresAt
  </action>
  <verify>
Check model file exists and has TTL index:
```bash
grep -n "expireAfterSeconds" backend/models/ReportHistory.js
grep -n "RETENTION_DAYS" backend/models/ReportHistory.js
```
  </verify>
  <done>ReportHistory model exists with TTL index, schema fields, static methods, and virtuals</done>
</task>

<task type="auto">
  <name>Task 2: Create reportHistoryService for file management</name>
  <files>backend/services/reportHistoryService.js</files>
  <action>
Create reportHistoryService following existing service patterns:

Directory constant: REPORTS_UPLOAD_DIR = path.join(process.cwd(), 'uploads', 'reports')

Methods:
1. ensureDir(companyId): Creates uploads/reports/{companyId}/ directory if not exists, returns dir path
2. generateFileName(reportType, format): Returns unique filename like "dqf-2026-02-04T15-30-00-a1b2c3d4.csv"
3. saveReport(fileBuffer, options):
   - Calls ensureDir(companyId)
   - Generates unique filename
   - Writes fileBuffer to disk
   - Gets file stats for size
   - Creates ReportHistory record with all metadata
   - Returns the created history document

   Options object:
   - companyId, userId, userEmail, reportType, reportName, format
   - filters (object), selectedFields (array), templateId, templateName, rowCount

4. deleteReport(historyId, companyId): Finds record, deletes file (ignore ENOENT), deletes record
5. cleanupOrphanFiles(): Scans uploads/reports/*/*, checks each file against DB, deletes orphans

Use uuid for unique filename segment.
Use fs.promises for async operations.
Log operations with [ReportHistory] prefix.
  </action>
  <verify>
Check service file exists with key methods:
```bash
grep -n "saveReport" backend/services/reportHistoryService.js
grep -n "ensureDir" backend/services/reportHistoryService.js
grep -n "uploads/reports" backend/services/reportHistoryService.js
```
  </verify>
  <done>reportHistoryService exists with file management methods for saving, deleting, and cleanup</done>
</task>

<task type="auto">
  <name>Task 3: Create reportHistory routes and register</name>
  <files>backend/routes/reportHistory.js, backend/routes/index.js</files>
  <action>
Create backend/routes/reportHistory.js following documents.js download pattern:

Standard setup:
- express.Router()
- require models, middleware (protect, restrictToCompany, checkPermission)
- require asyncHandler, AppError from errorHandler
- router.use(protect), router.use(restrictToCompany)

Endpoints:

GET / - List report history
- checkPermission('reports', 'view')
- Query params: reportType (optional filter), page (default 1), limit (default 20)
- Query: { companyId } + optional reportType filter
- Populate generatedBy with firstName lastName
- Sort by -generatedAt (newest first)
- Return { success, history, pagination: { page, limit, total, pages } }

GET /:id - Get single history record details
- checkPermission('reports', 'view')
- Find by _id and companyId
- Populate generatedBy and templateId
- 404 if not found
- Return { success, history }

GET /:id/download - Download previously generated report
- checkPermission('reports', 'view')
- Find by _id and companyId
- 404 if not found
- Check expiresAt < now, return 410 (Gone) with message "Report has expired"
- Check file exists with fs.existsSync, return 404 if not
- Set Content-Type based on format (csv, xlsx)
- Set Content-Disposition with fileName
- Set Content-Length with fileSize
- Stream file with fs.createReadStream().pipe(res)

MIME types:
- csv: 'text/csv; charset=utf-8'
- xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'

Register in backend/routes/index.js:
- Add require('./reportHistory') at top with other requires
- Add router.use('/report-history', reportHistoryRoutes) after report-templates
  </action>
  <verify>
Check routes exist and are registered:
```bash
grep -n "report-history" backend/routes/index.js
grep -n "/download" backend/routes/reportHistory.js
grep -n "410" backend/routes/reportHistory.js
```
  </verify>
  <done>reportHistory routes exist with list, detail, and download endpoints; routes registered in index.js</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. ReportHistory model has TTL index with expireAfterSeconds: 0
2. reportHistoryService has saveReport, ensureDir, cleanupOrphanFiles methods
3. reportHistory routes have GET /, GET /:id, GET /:id/download endpoints
4. Routes registered under /api/report-history in index.js
5. Download endpoint returns 410 for expired reports, 404 for missing files
</verification>

<success_criteria>
- ReportHistory model created with 90-day TTL index
- Service handles file storage in uploads/reports/{companyId}/
- List endpoint returns paginated history with user names
- Download endpoint serves files with proper Content-Type
- Expired reports return HTTP 410 Gone
</success_criteria>

<output>
After completion, create `.planning/phases/12-report-history/12-01-SUMMARY.md`
</output>
