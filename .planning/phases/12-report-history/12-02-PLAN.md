---
phase: 12-report-history
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - backend/routes/reports.js
  - frontend/src/utils/api.js
  - frontend/src/components/reports/ReportHistoryList.jsx
  - frontend/src/pages/Reports.jsx
autonomous: true

must_haves:
  truths:
    - "System automatically tracks each CSV/Excel report generation"
    - "User can view chronological list of previously generated reports"
    - "User can re-download any report within 90-day retention window"
    - "Report history shows filter parameters used for each generation"
  artifacts:
    - path: "backend/routes/reports.js"
      provides: "History tracking on export"
      contains: "reportHistoryService.saveReport"
    - path: "frontend/src/components/reports/ReportHistoryList.jsx"
      provides: "History list with download buttons"
      contains: "handleDownload"
    - path: "frontend/src/utils/api.js"
      provides: "reportHistoryAPI methods"
      contains: "reportHistoryAPI"
  key_links:
    - from: "backend/routes/reports.js"
      to: "backend/services/reportHistoryService.js"
      via: "require('../services/reportHistoryService')"
      pattern: "reportHistoryService\\.saveReport"
    - from: "frontend/src/components/reports/ReportHistoryList.jsx"
      to: "frontend/src/utils/api.js"
      via: "import { reportHistoryAPI }"
      pattern: "reportHistoryAPI\\.download"
    - from: "frontend/src/pages/Reports.jsx"
      to: "frontend/src/components/reports/ReportHistoryList.jsx"
      via: "import ReportHistoryList"
      pattern: "ReportHistoryList"
---

<objective>
Integrate history tracking into report exports and build the frontend UI for viewing and re-downloading reports.

Purpose: Enable users to view and re-download previously generated reports (HIST-02, HIST-04)
Output: Backend tracks exports, frontend displays history with download capability
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-report-history/12-RESEARCH.md
@.planning/phases/12-report-history/12-01-SUMMARY.md

# Existing patterns
@frontend/src/components/reports/TemplateManager.jsx
@frontend/src/pages/Reports.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate history tracking into report exports</name>
  <files>backend/routes/reports.js</files>
  <action>
Modify backend/routes/reports.js to track CSV/Excel exports.

At top of file, add require:
```javascript
const reportHistoryService = require('../services/reportHistoryService');
```

Create helper to capture export buffer and track history:
```javascript
// Helper to track report export in history
const trackReportExport = async (req, res, options) => {
  const { fileBuffer, format, reportType, reportName, rows, selectedFields, filters } = options;
  const companyId = req.companyFilter.companyId;

  // Save to history
  const history = await reportHistoryService.saveReport(fileBuffer, {
    companyId,
    userId: req.user._id,
    userEmail: req.user.email,
    reportType,
    reportName,
    format,
    filters,
    selectedFields,
    rowCount: rows.length
  });

  // Set response headers
  const fileName = exportService.generateFilename(reportType, format);
  const mimeTypes = {
    csv: 'text/csv; charset=utf-8',
    xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  };
  res.setHeader('Content-Type', mimeTypes[format]);
  res.setHeader('Content-Disposition', `attachment; filename="${fileName}"`);
  res.setHeader('X-Report-History-Id', history._id.toString());
  res.send(fileBuffer);
};
```

For each report endpoint (dqf, vehicle-maintenance, violations, audit, document-expiration, drug-alcohol, dataq-history, accident-summary, maintenance-costs), modify the CSV/XLSX export blocks:

Instead of streaming directly, capture to buffer first:
1. For CSV: Use PassThrough stream and collect chunks into buffer
2. For Excel: Use workbook.xlsx.writeBuffer()
3. Call trackReportExport with the buffer

Example for DQF CSV block (pattern for all):
```javascript
if (format === 'csv') {
  const { headers } = buildExportConfig('dqf', selectedFields);
  const { PassThrough } = require('stream');
  const passThrough = new PassThrough();
  const chunks = [];

  passThrough.on('data', chunk => chunks.push(chunk));
  passThrough.on('end', async () => {
    const fileBuffer = Buffer.concat(chunks);
    await trackReportExport(req, res, {
      fileBuffer,
      format: 'csv',
      reportType: 'dqf',
      reportName: 'Driver Qualification Files',
      rows,
      selectedFields,
      filters: {
        driverIds: driverIds ? driverIds.split(',') : undefined,
        complianceStatus: req.query.complianceStatus
      }
    });
  });

  passThrough.write('\ufeff'); // BOM
  const csvStream = exportService.createCSVStream(headers);
  csvStream.pipe(passThrough);
  rows.forEach(row => csvStream.write(row));
  csvStream.end();
  return;
}
```

Example for DQF Excel block:
```javascript
if (format === 'xlsx') {
  const { columns } = buildExportConfig('dqf', selectedFields);
  const ExcelJS = require('exceljs');
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Driver Qualification Files');
  worksheet.columns = columns;
  rows.forEach(row => worksheet.addRow(row));

  const fileBuffer = await workbook.xlsx.writeBuffer();
  await trackReportExport(req, res, {
    fileBuffer,
    format: 'xlsx',
    reportType: 'dqf',
    reportName: 'Driver Qualification Files',
    rows,
    selectedFields,
    filters: {
      driverIds: driverIds ? driverIds.split(',') : undefined,
      complianceStatus: req.query.complianceStatus
    }
  });
  return;
}
```

Apply this pattern to all 9 report types:
1. dqf - filters: driverIds, complianceStatus
2. vehicle-maintenance - filters: vehicleIds
3. violations - filters: driverIds, vehicleIds, startDate, endDate
4. audit - filters: none (full audit)
5. document-expiration - filters: driverIds, vehicleIds, expiryWindow
6. drug-alcohol - filters: startDate, endDate, testType
7. dataq-history - filters: startDate, endDate, driverIds, vehicleIds
8. accident-summary - filters: startDate, endDate, driverIds, vehicleIds
9. maintenance-costs - filters: startDate, endDate, vehicleIds

Note: The existing exportService.streamCSV needs to support creating a stream without auto-piping to response. If it doesn't, modify the CSV export to use @fast-csv/format directly inline.
  </action>
  <verify>
Check history tracking is integrated:
```bash
grep -n "reportHistoryService" backend/routes/reports.js
grep -n "trackReportExport" backend/routes/reports.js
```
  </verify>
  <done>All CSV/XLSX exports track generation in ReportHistory before streaming to client</done>
</task>

<task type="auto">
  <name>Task 2: Add reportHistoryAPI and create ReportHistoryList component</name>
  <files>frontend/src/utils/api.js, frontend/src/components/reports/ReportHistoryList.jsx</files>
  <action>
Add to frontend/src/utils/api.js after reportsAPI (near other API objects):

```javascript
export const reportHistoryAPI = {
  getAll: (params) => api.get('/report-history', { params }),
  getById: (id) => api.get(`/report-history/${id}`),
  download: (id) => api.get(`/report-history/${id}/download`, {
    responseType: 'blob',
    timeout: 300000 // 5 minutes for large files
  })
};
```

Create frontend/src/components/reports/ReportHistoryList.jsx:

Component structure:
- State: history (array), loading, pagination, filter.reportType, downloading (id or null)
- fetchHistory function with pagination support
- useEffect to fetch on mount and filter change
- handleDownload: gets blob, creates download link, triggers download
- formatFilters: converts filter object to readable string

REPORT_TYPE_LABELS constant (same as ReportPreview):
```javascript
const REPORT_TYPE_LABELS = {
  'dqf': 'Driver Qualification',
  'vehicle': 'Vehicle Maintenance',
  'violations': 'Violations Summary',
  'audit': 'Comprehensive Audit',
  'document-expiration': 'Document Expiration',
  'drug-alcohol': 'Drug & Alcohol',
  'dataq-history': 'DataQ History',
  'accident-summary': 'Accident Summary',
  'maintenance-costs': 'Maintenance Costs'
};
```

UI structure:
1. Filter row: Select dropdown for report type filter (All, then each type)
2. Table with columns:
   - Report Type (with row count subtitle)
   - Format (CSV/Excel badge)
   - Generated (formatted date/time)
   - Generated By (firstName lastName)
   - Filters Used (truncated string showing date range, driver count, etc.)
   - Expires (days remaining, amber warning if <= 7 days)
   - Download button (icon, shows spinner when downloading)

3. Pagination component at bottom (use existing Pagination if available)
4. Empty state: "No report history found"
5. Handle 410 error on download: show alert "Report has expired and is no longer available"

Styling: Follow existing component patterns (Tailwind, dark mode support):
- bg-white dark:bg-zinc-900 for card
- border-zinc-200/60 dark:border-zinc-800
- FiDownload, FiFile, FiClock, FiFilter icons from react-icons/fi
- Use date-fns format for dates: 'MMM d, yyyy h:mm a'

Import LoadingSpinner from components if exists, otherwise inline simple spinner.
  </action>
  <verify>
Check API and component exist:
```bash
grep -n "reportHistoryAPI" frontend/src/utils/api.js
ls -la frontend/src/components/reports/ReportHistoryList.jsx
grep -n "handleDownload" frontend/src/components/reports/ReportHistoryList.jsx
```
  </verify>
  <done>reportHistoryAPI added to api.js, ReportHistoryList component created with table, filtering, and download</done>
</task>

<task type="auto">
  <name>Task 3: Add Report History tab to Reports page</name>
  <files>frontend/src/pages/Reports.jsx</files>
  <action>
Modify frontend/src/pages/Reports.jsx to add Report History as a tab or section.

Add import:
```javascript
import ReportHistoryList from '../components/reports/ReportHistoryList';
```

Option A (Tab-based): If Reports page uses tabs, add "History" tab:
- Add 'history' to available tabs/views
- Render ReportHistoryList when history tab is active

Option B (Section-based): If no tabs, add collapsible section at bottom:
- Add showHistory state toggle
- Add "View Report History" button that expands/collapses section
- Render ReportHistoryList in expandable section

Either approach should:
1. Keep history visible/accessible from the Reports page
2. Not interfere with current report generation workflow
3. Allow user to switch between generating reports and viewing history

If the page has a tabbed interface, prefer tabs. The tab should be labeled "History" and show count badge if possible.

Example tab addition:
```jsx
const tabs = ['generate', 'history']; // or whatever current tabs exist

// In tab buttons section:
<button
  onClick={() => setActiveTab('history')}
  className={`px-4 py-2 ${activeTab === 'history' ? 'border-b-2 border-primary-500' : ''}`}
>
  Report History
</button>

// In tab content section:
{activeTab === 'history' && <ReportHistoryList />}
```
  </action>
  <verify>
Check integration:
```bash
grep -n "ReportHistoryList" frontend/src/pages/Reports.jsx
grep -n "history" frontend/src/pages/Reports.jsx
```
  </verify>
  <done>Reports page includes Report History tab/section with ReportHistoryList component integrated</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Export a report (e.g., DQF as CSV) - should complete and show X-Report-History-Id header
2. Check uploads/reports/{companyId}/ has the file saved
3. Visit Reports page, open History tab
4. History list shows the just-generated report with correct details
5. Click download - file downloads successfully
6. Filter by report type - list filters correctly
7. Filter metadata shows "From: date, To: date, X drivers" etc.
</verification>

<success_criteria>
- All 9 report type exports save to history before streaming
- reportHistoryAPI has getAll, getById, download methods
- ReportHistoryList displays history with all columns
- Download button works and handles 410 expired gracefully
- Reports page has accessible History view
</success_criteria>

<output>
After completion, create `.planning/phases/12-report-history/12-02-SUMMARY.md`
</output>
