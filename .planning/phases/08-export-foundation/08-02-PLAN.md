---
phase: 08-export-foundation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - frontend/src/utils/api.js
  - frontend/src/pages/Reports.jsx
autonomous: true

must_haves:
  truths:
    - "User can click CSV button on any report card and file downloads"
    - "User can click Excel button on any report card and file downloads"
    - "Downloaded files open correctly in Excel with proper formatting"
    - "Loading states show during export generation"
  artifacts:
    - path: "frontend/src/utils/api.js"
      provides: "Updated reportsAPI with blob responseType for CSV/XLSX"
      contains: "responseType.*blob"
    - path: "frontend/src/pages/Reports.jsx"
      provides: "CSV and Excel download buttons on report cards"
      contains: "Download CSV"
  key_links:
    - from: "frontend/src/pages/Reports.jsx"
      to: "frontend/src/utils/api.js"
      via: "reportsAPI method calls with format param"
      pattern: "format.*xlsx"
    - from: "frontend/src/pages/Reports.jsx"
      to: "frontend/src/utils/helpers.js"
      via: "downloadBlob for file download"
      pattern: "downloadBlob"
---

<objective>
Add CSV and Excel export buttons to the Reports page and update the API client to handle binary responses.

Purpose: Enable users to download reports in CSV and Excel format directly from the Reports UI.
Output: Reports page with CSV/Excel buttons, API client properly configured for blob responses.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-foundation/08-RESEARCH.md
@.planning/phases/08-export-foundation/08-01-SUMMARY.md
@frontend/src/utils/api.js
@frontend/src/pages/Reports.jsx
@frontend/src/utils/helpers.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update reportsAPI to handle binary responses for CSV/Excel</name>
  <files>frontend/src/utils/api.js</files>
  <action>
Modify `frontend/src/utils/api.js`:

Update the reportsAPI object to set responseType: 'blob' for PDF, CSV, and XLSX formats.

Current pattern (for reference):
```javascript
export const reportsAPI = {
  getDqfReport: (params) => api.get('/reports/dqf', { params, responseType: params.format === 'pdf' ? 'blob' : 'json' }),
  // ...
};
```

Updated pattern for all four methods:
```javascript
export const reportsAPI = {
  getDqfReport: (params) => api.get('/reports/dqf', {
    params,
    responseType: ['pdf', 'csv', 'xlsx'].includes(params.format) ? 'blob' : 'json'
  }),
  getVehicleMaintenanceReport: (params) => api.get('/reports/vehicle-maintenance', {
    params,
    responseType: ['pdf', 'csv', 'xlsx'].includes(params.format) ? 'blob' : 'json'
  }),
  getViolationsReport: (params) => api.get('/reports/violations', {
    params,
    responseType: ['pdf', 'csv', 'xlsx'].includes(params.format) ? 'blob' : 'json'
  }),
  getAuditReport: (params) => api.get('/reports/audit', {
    params,
    responseType: ['pdf', 'csv', 'xlsx'].includes(params.format) ? 'blob' : 'json'
  })
};
```

Also increase timeout for export endpoints to handle large reports:
- Add timeout: 300000 (5 minutes) for blob requests only
- Pattern: `...((['pdf', 'csv', 'xlsx'].includes(params.format)) && { timeout: 300000 })`
  </action>
  <verify>
```bash
cd frontend && grep -A2 "getDqfReport" src/utils/api.js | grep -c "xlsx"
```
Should output 1 (xlsx is in the responseType check).
  </verify>
  <done>reportsAPI methods set responseType: 'blob' for pdf, csv, and xlsx formats with extended timeout</done>
</task>

<task type="auto">
  <name>Task 2: Add CSV and Excel buttons to Reports page</name>
  <files>frontend/src/pages/Reports.jsx</files>
  <action>
Modify `frontend/src/pages/Reports.jsx`:

1. **Add file table icon import** - At top with other icons:
```javascript
import { FiFileText, FiDownload, FiUsers, FiTruck, FiAlertTriangle, FiClipboard, FiFile } from 'react-icons/fi';
// FiFile for CSV, existing FiFileText for Excel
```

Or use FiTable for spreadsheet icon if available. Keep it simple - FiDownload works for all.

2. **Update handleGenerateReport function** - Modify the download handling:

```javascript
const handleGenerateReport = async (reportId, format = 'pdf') => {
  const report = reports.find(r => r.id === reportId);
  if (!report) return;

  setGenerating({ ...generating, [reportId]: format });

  try {
    const params = {
      format,
      ...(report.hasDateRange && dateRange.startDate && { startDate: dateRange.startDate }),
      ...(report.hasDateRange && dateRange.endDate && { endDate: dateRange.endDate })
    };

    const response = await report.api(params);

    if (['pdf', 'csv', 'xlsx'].includes(format)) {
      // Map format to file extension
      const extension = format;
      downloadBlob(response.data, `${report.id}-report-${Date.now()}.${extension}`);
      toast.success(`${format.toUpperCase()} report downloaded successfully`);
    } else {
      // JSON preview could be shown in a modal
      toast.success('Report data retrieved');
    }
  } catch (error) {
    toast.error(`Failed to generate ${report.title}`);
  } finally {
    setGenerating({ ...generating, [reportId]: false });
  }
};
```

3. **Add CSV and Excel buttons to each report card** - In the button section of each card:

Replace the existing two-button group with:
```jsx
<div className="flex flex-wrap gap-2 mt-4">
  <button
    onClick={() => handleGenerateReport(report.id, 'pdf')}
    disabled={isGenerating}
    className="btn btn-primary btn-sm flex items-center"
  >
    {isGenerating === 'pdf' ? (
      <LoadingSpinner size="sm" className="mr-2" />
    ) : (
      <FiDownload className="w-4 h-4 mr-2" />
    )}
    PDF
  </button>
  <button
    onClick={() => handleGenerateReport(report.id, 'csv')}
    disabled={isGenerating}
    className="btn btn-secondary btn-sm flex items-center"
  >
    {isGenerating === 'csv' ? (
      <LoadingSpinner size="sm" className="mr-2" />
    ) : (
      <FiDownload className="w-4 h-4 mr-2" />
    )}
    CSV
  </button>
  <button
    onClick={() => handleGenerateReport(report.id, 'xlsx')}
    disabled={isGenerating}
    className="btn btn-secondary btn-sm flex items-center"
  >
    {isGenerating === 'xlsx' ? (
      <LoadingSpinner size="sm" className="mr-2" />
    ) : (
      <FiDownload className="w-4 h-4 mr-2" />
    )}
    Excel
  </button>
  <button
    onClick={() => handleGenerateReport(report.id, 'json')}
    disabled={isGenerating}
    className="btn btn-secondary btn-sm flex items-center"
  >
    {isGenerating === 'json' ? (
      <LoadingSpinner size="sm" className="mr-2" />
    ) : (
      <FiFileText className="w-4 h-4 mr-2" />
    )}
    View Data
  </button>
</div>
```

4. **Update page description** - Change from "Generate PDF reports" to:
```jsx
<p className="text-zinc-600 dark:text-zinc-300">Generate and export compliance reports in PDF, CSV, or Excel format</p>
```
  </action>
  <verify>
```bash
cd frontend && grep -c "Download CSV\|CSV\|xlsx" src/pages/Reports.jsx
```
Should show matches for CSV and xlsx button text/format.

```bash
cd frontend && npm run build
```
Build should complete without errors.
  </verify>
  <done>Reports page has PDF, CSV, Excel, and View Data buttons for all report types with loading states</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification</name>
  <files>None (verification only)</files>
  <action>
Verify the complete export flow works:

1. **Check backend compiles:**
```bash
cd backend && node -e "require('./server')" &
sleep 3 && kill %1
```

2. **Check frontend builds:**
```bash
cd frontend && npm run build
```

3. **Code verification checks:**
- UTF-8 BOM in exportService.js: `grep -c "\\\\ufeff" backend/services/exportService.js` should be >= 1
- WorkbookWriter used (not Workbook): `grep -c "WorkbookWriter" backend/services/exportService.js` should be >= 1
- All endpoints have format checks: `grep -c "format === 'csv'" backend/routes/reports.js` should be 4
- Frontend has blob handling: `grep -c "xlsx.*blob" frontend/src/utils/api.js` should be >= 1

4. **Verify service exports:**
```bash
cd backend && node -e "const svc = require('./services/exportService'); console.log('generateFilename:', typeof svc.generateFilename); console.log('streamCSV:', typeof svc.streamCSV); console.log('streamExcel:', typeof svc.streamExcel);"
```
Should output all three as 'function'.
  </action>
  <verify>
All verification commands pass without errors.
  </verify>
  <done>Export functionality complete - backend serves CSV/Excel, frontend downloads them correctly</done>
</task>

</tasks>

<verification>
1. Frontend build succeeds without errors
2. Backend compiles and starts without errors
3. Reports page shows PDF, CSV, Excel buttons for all four report types
4. reportsAPI methods handle blob responses for csv and xlsx formats
5. Code includes UTF-8 BOM for CSV and uses streaming WorkbookWriter for Excel
</verification>

<success_criteria>
- User can click CSV button on any report and file downloads
- User can click Excel button on any report and file downloads
- Loading spinner shows during generation
- Success toast appears after download
- Frontend build passes
- Backend compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-foundation/08-02-SUMMARY.md`
</output>
