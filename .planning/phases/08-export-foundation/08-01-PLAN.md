---
phase: 08-export-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/services/exportService.js
  - backend/routes/reports.js
  - backend/package.json
autonomous: true

must_haves:
  truths:
    - "CSV export streams to response with UTF-8 BOM for Spanish character support"
    - "Excel export streams using WorkbookWriter for memory efficiency"
    - "All four report endpoints accept format=csv and format=xlsx query params"
    - "Downloaded files have descriptive names with report type and timestamp"
  artifacts:
    - path: "backend/services/exportService.js"
      provides: "Streaming CSV and Excel export methods"
      exports: ["streamCSV", "streamExcel", "generateFilename"]
      min_lines: 80
    - path: "backend/routes/reports.js"
      provides: "Extended report endpoints with CSV/Excel format handling"
      contains: "format === 'csv'"
  key_links:
    - from: "backend/routes/reports.js"
      to: "backend/services/exportService.js"
      via: "require and method calls"
      pattern: "exportService\\.stream(CSV|Excel)"
---

<objective>
Create the export service and extend report endpoints to support CSV and Excel formats.

Purpose: Enable backend to generate CSV and Excel files with streaming architecture for memory efficiency on large reports.
Output: exportService.js with streamCSV/streamExcel methods, all four report routes extended with format=csv/xlsx support.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-foundation/08-RESEARCH.md
@backend/routes/reports.js
@backend/services/emailService.js (pattern reference for service structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create exportService.js</name>
  <files>
    backend/package.json
    backend/services/exportService.js
  </files>
  <action>
Install required packages:
```bash
cd backend && npm install exceljs @fast-csv/format
```

Create `backend/services/exportService.js` with:

1. **generateFilename(reportType, extension)** - Creates descriptive filename with timestamp
   - Format: `{reportType}-{yyyy-MM-dd-HHmm}.{extension}`
   - Use date-fns format (already in codebase)

2. **streamCSV(res, { reportType, headers, rows })** - Streams CSV to Express response
   - Set Content-Type: `text/csv; charset=utf-8`
   - Set Content-Disposition with filename from generateFilename
   - Write UTF-8 BOM (`\ufeff`) BEFORE piping CSV stream (CRITICAL for Spanish characters in Excel)
   - Use @fast-csv/format with `{ headers: true }`
   - Pipe csvStream to res
   - Write each row object (keys should match headers)
   - Call csvStream.end() when done

3. **streamExcel(res, { reportType, sheetName, columns, rows })** - Streams Excel to Express response
   - Set Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
   - Set Content-Disposition with filename from generateFilename
   - Use ExcelJS stream.xlsx.WorkbookWriter (NOT regular Workbook - critical for memory)
   - Create worksheet with addWorksheet(sheetName)
   - Set worksheet.columns from columns array (each has header, key, width)
   - Style header row: bold font, light gray fill (argb: FFE8E8E8), center alignment
   - Call headerRow.commit() immediately
   - Loop through rows, addRow and commit() each row immediately (memory efficiency)
   - await worksheet.commit() then await workbook.commit() (CRITICAL - must await both)

Export as object literal (match codebase service pattern).
  </action>
  <verify>
```bash
cd backend && node -e "const svc = require('./services/exportService'); console.log(Object.keys(svc))"
```
Should output: `[ 'generateFilename', 'streamCSV', 'streamExcel' ]`
  </verify>
  <done>exportService.js exists with all three methods, dependencies installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Extend DQF and Vehicle Maintenance report endpoints</name>
  <files>backend/routes/reports.js</files>
  <action>
Modify `backend/routes/reports.js`:

1. Add require at top:
```javascript
const exportService = require('../services/exportService');
```

2. **GET /dqf endpoint** - Add CSV/Excel handling before existing PDF check:

For CSV format:
- Call exportService.streamCSV with:
  - reportType: 'dqf-report'
  - headers: object with keys matching row data
  - rows: drivers.map to objects with keys: driverName, employeeId, cdlNumber, cdlState, cdlExpiry, medicalExpiry, overallStatus

For Excel format:
- Call exportService.streamExcel with:
  - reportType: 'dqf-report'
  - sheetName: 'Driver Qualification Files'
  - columns: Array of { header, key, width } for each field (widths: name 25, employeeId 15, cdl fields 15, status 15)
  - rows: Same mapping as CSV

3. **GET /vehicle-maintenance endpoint** - Add CSV/Excel handling:

For CSV format:
- reportType: 'vehicle-maintenance-report'
- rows: vehicles.map to objects with: unitNumber, vehicleType, vin, status, nextInspection, lastMaintenance

For Excel format:
- sheetName: 'Vehicle Maintenance'
- columns with appropriate widths (unitNumber 12, type 15, vin 20, status 12, dates 15)

Both endpoints: Add `return` after streamCSV/streamExcel calls to prevent further execution.
  </action>
  <verify>
```bash
cd backend && grep -c "format === 'csv'" routes/reports.js && grep -c "format === 'xlsx'" routes/reports.js
```
Should output 2 for each (DQF + vehicle-maintenance endpoints).
  </verify>
  <done>DQF and Vehicle Maintenance endpoints support format=csv and format=xlsx</done>
</task>

<task type="auto">
  <name>Task 3: Extend Violations and Audit report endpoints</name>
  <files>backend/routes/reports.js</files>
  <action>
Continue modifying `backend/routes/reports.js`:

1. **GET /violations endpoint** - Add CSV/Excel handling:

For CSV format:
- reportType: 'violations-report'
- rows: violations.map to objects with: violationDate (formatted), violationType, basic, severityWeight, driverName, vehicleUnit, status, dataQStatus

For Excel format:
- sheetName: 'Violations Summary'
- columns: date 12, type 25, basic 20, severity 10, driver 25, vehicle 12, status 15, dataQ 15

2. **GET /audit endpoint** - Add CSV/Excel handling:

For CSV format:
- reportType: 'audit-report'
- This is a summary report, so flatten the data:
  - rows: Single or multiple rows with: section, metric, value
  - Example rows: { section: 'Drivers', metric: 'Total Active', value: auditData.driverQualification.totalActive }
  - Include all summary sections: Company, Drivers, Vehicles, Violations, Drug/Alcohol, Documents

For Excel format:
- sheetName: 'Comprehensive Audit'
- columns: section 20, metric 30, value 15
- Same row structure as CSV

Use date-fns format for date formatting (already available as pdf.formatDate uses it).
Add `const { format: formatDate } = require('date-fns');` at top if not present.
  </action>
  <verify>
```bash
cd backend && grep -c "format === 'csv'" routes/reports.js && grep -c "format === 'xlsx'" routes/reports.js
```
Should output 4 for each (all four endpoints).

Manual test with curl:
```bash
# Start server, then:
# curl -H "Authorization: Bearer $TOKEN" "http://localhost:5001/api/reports/dqf?format=csv" --output test.csv
# Open test.csv in Excel - Spanish characters should display correctly
```
  </verify>
  <done>All four report endpoints (DQF, Vehicle Maintenance, Violations, Audit) support format=csv and format=xlsx</done>
</task>

</tasks>

<verification>
1. exportService.js exists and exports all three methods
2. All four report endpoints have CSV and Excel format handling
3. npm install succeeded (exceljs and @fast-csv/format in dependencies)
4. Code compiles without errors: `cd backend && node -e "require('./routes/reports')"`
</verification>

<success_criteria>
- exportService.js provides streamCSV and streamExcel methods with streaming architecture
- UTF-8 BOM is written to CSV output (check for `\ufeff` in code)
- All four report routes accept format=csv and format=xlsx
- ExcelJS WorkbookWriter is used (not regular Workbook) for memory efficiency
- Files have descriptive names with timestamps
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-foundation/08-01-SUMMARY.md`
</output>
