---
phase: 11-report-builder
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - frontend/src/components/reports/FieldSelector.jsx
  - frontend/src/components/reports/ReportPreview.jsx
  - frontend/src/components/reports/TemplateManager.jsx
  - frontend/src/utils/api.js
  - frontend/src/utils/reportFieldConfig.js
  - frontend/src/pages/Reports.jsx
autonomous: true

must_haves:
  truths:
    - "User can select/deselect fields via checkboxes in FieldSelector component"
    - "User can see preview of first 10 rows before downloading full report"
    - "User can save current configuration as named template via TemplateManager"
    - "User can load saved template and see fields/filters applied"
    - "User can see and load pre-built FMCSA templates (DQF Audit, Vehicle Inspection, Violations Summary)"
    - "User can duplicate any template including system templates"
  artifacts:
    - path: "frontend/src/components/reports/FieldSelector.jsx"
      provides: "Checkbox-based field selection component"
      contains: "selectedFields"
    - path: "frontend/src/components/reports/ReportPreview.jsx"
      provides: "Preview table showing first 10 rows"
      contains: "preview"
    - path: "frontend/src/components/reports/TemplateManager.jsx"
      provides: "Save/load/duplicate template UI"
      contains: "template"
    - path: "frontend/src/utils/api.js"
      provides: "API methods for templates and preview"
      contains: "reportTemplatesAPI"
    - path: "frontend/src/pages/Reports.jsx"
      provides: "Integrated report builder UI"
      contains: "FieldSelector"
  key_links:
    - from: "frontend/src/pages/Reports.jsx"
      to: "frontend/src/components/reports/FieldSelector.jsx"
      via: "component import"
      pattern: "import.*FieldSelector"
    - from: "frontend/src/components/reports/ReportPreview.jsx"
      to: "frontend/src/utils/api.js"
      via: "preview API call"
      pattern: "reportsAPI.getPreview"
    - from: "frontend/src/components/reports/TemplateManager.jsx"
      to: "frontend/src/utils/api.js"
      via: "template CRUD calls"
      pattern: "reportTemplatesAPI"
---

<objective>
Create frontend components for the report builder: FieldSelector (checkboxes), ReportPreview (10-row preview), and TemplateManager (save/load/duplicate). Integrate into Reports page.

Purpose: Enable users to customize report output, preview before downloading, and save configurations as reusable templates.
Output: Working report builder UI with field selection, preview, and template management
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-report-builder/11-RESEARCH.md
@.planning/phases/11-report-builder/11-01-SUMMARY.md
@.planning/phases/11-report-builder/11-02-SUMMARY.md
@frontend/src/pages/Reports.jsx
@frontend/src/utils/api.js
@frontend/src/components/filters/MultiSelectDropdown.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API methods and field config for report builder</name>
  <files>
    frontend/src/utils/api.js
    frontend/src/utils/reportFieldConfig.js
  </files>
  <action>
Add reportTemplatesAPI and preview methods to frontend/src/utils/api.js:

```javascript
// Report Templates API
export const reportTemplatesAPI = {
  getAll: (params) => api.get('/report-templates', { params }),
  getById: (id) => api.get(`/report-templates/${id}`),
  create: (data) => api.post('/report-templates', data),
  update: (id, data) => api.put(`/report-templates/${id}`, data),
  delete: (id) => api.delete(`/report-templates/${id}`),
  duplicate: (id) => api.post(`/report-templates/${id}/duplicate`)
};
```

Add preview methods to reportsAPI object:
```javascript
export const reportsAPI = {
  // ... existing methods ...
  getPreview: (reportType, params) => {
    const endpoints = {
      'dqf': '/reports/dqf/preview',
      'vehicle': '/reports/vehicle-maintenance/preview',
      'violations': '/reports/violations/preview',
      'audit': '/reports/audit/preview',
      'document-expiration': '/reports/document-expiration/preview',
      'drug-alcohol': '/reports/drug-alcohol-summary/preview',
      'dataq-history': '/reports/dataq-history/preview',
      'accident-summary': '/reports/accident-summary/preview',
      'maintenance-costs': '/reports/maintenance-costs/preview'
    };
    return api.get(endpoints[reportType], { params });
  }
};
```

Create frontend/src/utils/reportFieldConfig.js with field definitions matching backend:

```javascript
// Field definitions for all report types (frontend copy of backend config)
export const REPORT_FIELD_DEFINITIONS = {
  dqf: {
    fields: [
      { key: 'driverName', label: 'Driver Name', default: true },
      { key: 'employeeId', label: 'Employee ID', default: true },
      { key: 'cdlNumber', label: 'CDL Number', default: true },
      { key: 'cdlState', label: 'CDL State', default: true },
      { key: 'cdlClass', label: 'CDL Class', default: false },
      { key: 'cdlExpiry', label: 'CDL Expiry', default: true, type: 'date' },
      { key: 'medicalExpiry', label: 'Medical Card Expiry', default: true, type: 'date' },
      { key: 'overallStatus', label: 'Overall Status', default: true },
      { key: 'clearinghouseQueryDate', label: 'Clearinghouse Query Date', default: false, type: 'date' },
      { key: 'clearinghouseStatus', label: 'Clearinghouse Status', default: false },
      { key: 'mvrReviewDate', label: 'MVR Review Date', default: false, type: 'date' },
      { key: 'mvrApproved', label: 'MVR Approved', default: false, type: 'boolean' },
      { key: 'employmentVerificationStatus', label: 'Employment Verification', default: false },
      { key: 'roadTestDate', label: 'Road Test Date', default: false, type: 'date' },
      { key: 'roadTestResult', label: 'Road Test Result', default: false }
    ]
  },
  // ... similar for all 9 report types (vehicle, violations, audit, document-expiration, drug-alcohol, dataq-history, accident-summary, maintenance-costs)
};

export const getDefaultFields = (reportType) => {
  const def = REPORT_FIELD_DEFINITIONS[reportType];
  if (!def) return [];
  return def.fields.filter(f => f.default).map(f => f.key);
};
```

Include complete field definitions for all 9 report types matching the backend config created in 11-01.
  </action>
  <verify>
    - `grep "reportTemplatesAPI" frontend/src/utils/api.js` shows export
    - `grep "getPreview" frontend/src/utils/api.js` shows method
    - frontend/src/utils/reportFieldConfig.js exists and exports REPORT_FIELD_DEFINITIONS
    - `node -e "const r = require('./frontend/src/utils/reportFieldConfig.js'); console.log(Object.keys(r.REPORT_FIELD_DEFINITIONS).length)"` outputs 9
  </verify>
  <done>API methods for templates and preview added, field config with all 9 report types created</done>
</task>

<task type="auto">
  <name>Task 2: Create FieldSelector, ReportPreview, and TemplateManager components</name>
  <files>
    frontend/src/components/reports/FieldSelector.jsx
    frontend/src/components/reports/ReportPreview.jsx
    frontend/src/components/reports/TemplateManager.jsx
  </files>
  <action>
Create frontend/src/components/reports/FieldSelector.jsx:
- Props: reportType, fieldDefinitions (from config), selectedFields, onFieldsChange
- Display checkboxes in a 2-4 column grid (responsive)
- Show field labels with (default) indicator for default fields
- Include Select All / Defaults / Clear buttons at top
- Style using existing Tailwind patterns (see MultiSelectDropdown for reference)
- Highlight selected fields with primary color border
- Show count: "Fields to Include (X/Y)"

Create frontend/src/components/reports/ReportPreview.jsx:
- Props: reportType, selectedFields, filters, onClose (optional)
- Fetch preview on mount and when selectedFields or filters change (300ms debounce)
- Show LoadingSpinner while loading
- Display table with columns from preview.columns
- Format cell values by type (date -> toLocaleDateString, boolean -> Yes/No)
- Show "Showing X of Y rows" header
- Show "+ N more rows in full report" footer if hasMore
- Handle error state with error message

Create frontend/src/components/reports/TemplateManager.jsx:
- Props: reportType, currentConfig (fields + filters), onLoadTemplate
- Fetch templates for reportType on mount
- Display dropdown to select template (group: System Templates / My Templates)
- Show template name with (System) badge for isSystemTemplate=true
- Load button applies template's selectedFields and filters via onLoadTemplate callback
- Save button opens modal: name input, description input, save button
- Duplicate button for system templates (POST /duplicate endpoint)
- Delete button with confirmation for user templates (not shown for system templates)
- Use toast for success/error feedback

Follow existing component patterns in the codebase for styling (cards, buttons, form inputs).
  </action>
  <verify>
    - All three component files exist in frontend/src/components/reports/
    - `grep "export default" frontend/src/components/reports/FieldSelector.jsx` shows export
    - `grep "export default" frontend/src/components/reports/ReportPreview.jsx` shows export
    - `grep "export default" frontend/src/components/reports/TemplateManager.jsx` shows export
    - No ESLint errors: `cd frontend && npm run lint -- --quiet`
  </verify>
  <done>FieldSelector, ReportPreview, and TemplateManager components created with proper styling and functionality</done>
</task>

<task type="auto">
  <name>Task 3: Integrate report builder components into Reports page</name>
  <files>frontend/src/pages/Reports.jsx</files>
  <action>
Update frontend/src/pages/Reports.jsx to integrate the report builder components:

1. Add imports at top:
```javascript
import FieldSelector from '../components/reports/FieldSelector';
import ReportPreview from '../components/reports/ReportPreview';
import TemplateManager from '../components/reports/TemplateManager';
import { REPORT_FIELD_DEFINITIONS, getDefaultFields } from '../utils/reportFieldConfig';
```

2. Add state for field selection and preview:
```javascript
const [selectedFields, setSelectedFields] = useState({});
const [showPreview, setShowPreview] = useState(false);

// Initialize fields when report type changes
useEffect(() => {
  if (!selectedFields[selectedReportId]) {
    setSelectedFields(prev => ({
      ...prev,
      [selectedReportId]: getDefaultFields(selectedReportId)
    }));
  }
}, [selectedReportId]);
```

3. Add handler for loading templates:
```javascript
const handleLoadTemplate = (template) => {
  setSelectedFields(prev => ({
    ...prev,
    [template.reportType]: template.selectedFields
  }));
  if (template.filters) {
    setActiveFilters(template.filters);
  }
  toast.success(`Loaded template: ${template.name}`);
};
```

4. Update handleGenerateReport to include fields:
```javascript
const handleGenerateReport = async (reportId, format = 'pdf') => {
  // ... existing code ...
  const params = { format };
  // Add fields param if not all fields selected
  const allFields = REPORT_FIELD_DEFINITIONS[reportId]?.fields.map(f => f.key) || [];
  const currentFields = selectedFields[reportId] || allFields;
  if (currentFields.length < allFields.length) {
    params.fields = currentFields.join(',');
  }
  // ... rest of existing code ...
};
```

5. Add Report Builder section below Report Type Selector (and above Report Filters):
```jsx
{/* Report Builder */}
<div className="space-y-4">
  {/* Template Manager */}
  <TemplateManager
    reportType={selectedReportId}
    currentConfig={{
      selectedFields: selectedFields[selectedReportId] || [],
      filters: activeFilters
    }}
    onLoadTemplate={handleLoadTemplate}
  />

  {/* Field Selector */}
  <FieldSelector
    reportType={selectedReportId}
    fieldDefinitions={REPORT_FIELD_DEFINITIONS}
    selectedFields={selectedFields[selectedReportId] || []}
    onFieldsChange={(fields) => setSelectedFields(prev => ({
      ...prev,
      [selectedReportId]: fields
    }))}
  />

  {/* Preview Toggle */}
  <div className="flex justify-end">
    <button
      onClick={() => setShowPreview(!showPreview)}
      className="btn btn-secondary btn-sm"
    >
      {showPreview ? 'Hide Preview' : 'Show Preview'}
    </button>
  </div>

  {/* Preview Panel */}
  {showPreview && (
    <ReportPreview
      reportType={selectedReportId}
      selectedFields={selectedFields[selectedReportId] || []}
      filters={activeFilters}
      onClose={() => setShowPreview(false)}
    />
  )}
</div>
```

6. The existing ReportFilters should remain below the builder section.

Ensure the page layout flows naturally: Report Type Selector -> Template Manager -> Field Selector -> Preview -> Filters -> Report Cards
  </action>
  <verify>
    - `grep "FieldSelector" frontend/src/pages/Reports.jsx` shows import and usage
    - `grep "ReportPreview" frontend/src/pages/Reports.jsx` shows import and usage
    - `grep "TemplateManager" frontend/src/pages/Reports.jsx` shows import and usage
    - `cd frontend && npm run lint -- --quiet` passes
    - `cd frontend && npm run build` succeeds
    - Manual test: Start frontend, navigate to Reports page, verify:
      - Field checkboxes appear when report type selected
      - Can toggle fields and see count change
      - Preview button shows/hides preview panel
      - Can load a system template
      - Downloaded report respects field selection
  </verify>
  <done>Reports page fully integrated with field selection, preview, and template management</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Frontend builds without errors: `cd frontend && npm run build`
2. No lint errors: `cd frontend && npm run lint`
3. Functional test in browser:
   - Select report type -> field checkboxes appear with defaults
   - Click "Select All" -> all fields checked
   - Click "Defaults" -> default fields checked
   - Click "Show Preview" -> preview table loads with selected columns
   - Change field selection -> preview updates (with debounce)
   - Click "Save Template" -> modal appears, can save
   - Template appears in dropdown, can be loaded
   - System templates visible and can be duplicated
   - Download report with field selection -> exported file has only selected columns
</verification>

<success_criteria>
- FieldSelector shows checkboxes for all fields, supports Select All/Defaults/Clear
- ReportPreview shows first 10 rows with selected columns, debounced updates
- TemplateManager lists system + user templates, supports save/load/duplicate
- Reports page integrates all components seamlessly
- Field selection is passed to report generation endpoints
- All 5 success criteria from roadmap satisfied:
  1. User can select/deselect fields via checkboxes
  2. User can save configuration as named template
  3. User can load saved template
  4. User can preview first 10 rows before download
  5. System provides pre-built FMCSA templates that can be duplicated
</success_criteria>

<output>
After completion, create `.planning/phases/11-report-builder/11-03-SUMMARY.md`
</output>
