---
phase: 11-report-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/models/ReportTemplate.js
  - backend/config/reportFieldDefinitions.js
  - backend/routes/reportTemplates.js
  - backend/routes/index.js
autonomous: true

must_haves:
  truths:
    - "ReportTemplate model stores company-scoped report configurations with selectedFields array"
    - "Field definitions exist for all 9 report types with label, key, default flag, and type metadata"
    - "CRUD operations available for report templates at /api/report-templates"
    - "System templates marked isSystemTemplate=true cannot be edited or deleted"
  artifacts:
    - path: "backend/models/ReportTemplate.js"
      provides: "ReportTemplate mongoose model"
      contains: "selectedFields"
    - path: "backend/config/reportFieldDefinitions.js"
      provides: "REPORT_FIELD_DEFINITIONS object with 9 report types"
      exports: ["REPORT_FIELD_DEFINITIONS", "getDefaultFields", "validateFields"]
    - path: "backend/routes/reportTemplates.js"
      provides: "CRUD routes for templates"
      contains: "router.get"
  key_links:
    - from: "backend/routes/reportTemplates.js"
      to: "backend/models/ReportTemplate.js"
      via: "mongoose model import"
      pattern: "require.*ReportTemplate"
    - from: "backend/routes/index.js"
      to: "backend/routes/reportTemplates.js"
      via: "route registration"
      pattern: "reportTemplateRoutes"
---

<objective>
Create the backend foundation for report templates: the ReportTemplate model, field definitions configuration, and CRUD routes.

Purpose: Enable storing user report configurations with field selections, and provide field metadata for all 9 report types.
Output: ReportTemplate model, reportFieldDefinitions.js config, reportTemplates routes registered at /api/report-templates
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-report-builder/11-RESEARCH.md
@backend/models/ChecklistTemplate.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReportTemplate model and field definitions config</name>
  <files>
    backend/models/ReportTemplate.js
    backend/config/reportFieldDefinitions.js
  </files>
  <action>
Create backend/models/ReportTemplate.js following the ChecklistTemplate pattern:

```javascript
const mongoose = require('mongoose');

const reportTemplateSchema = new mongoose.Schema({
  companyId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Company',
    index: true
  },
  createdBy: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  name: {
    type: String,
    required: [true, 'Template name is required'],
    trim: true,
    maxlength: 100
  },
  description: {
    type: String,
    trim: true,
    maxlength: 500
  },
  reportType: {
    type: String,
    required: true,
    enum: ['dqf', 'vehicle', 'violations', 'audit', 'document-expiration',
           'drug-alcohol', 'dataq-history', 'accident-summary', 'maintenance-costs'],
    index: true
  },
  selectedFields: [{
    type: String,
    trim: true
  }],
  filters: {
    startDate: Date,
    endDate: Date,
    driverIds: [{ type: mongoose.Schema.Types.ObjectId }],
    vehicleIds: [{ type: mongoose.Schema.Types.ObjectId }],
    status: String
  },
  isSystemTemplate: {
    type: Boolean,
    default: false
  },
  isActive: {
    type: Boolean,
    default: true
  }
}, {
  timestamps: true
});

reportTemplateSchema.index({ companyId: 1, reportType: 1 });
reportTemplateSchema.index({ isSystemTemplate: 1, reportType: 1 });

// Static: Get pre-built FMCSA system templates
reportTemplateSchema.statics.getSystemTemplates = function() {
  return [
    {
      name: 'DQF Audit Export',
      description: '49 CFR 391.51 compliance fields for DOT audit',
      reportType: 'dqf',
      isSystemTemplate: true,
      selectedFields: [
        'driverName', 'employeeId', 'cdlNumber', 'cdlState', 'cdlExpiry',
        'medicalExpiry', 'clearinghouseQueryDate', 'clearinghouseStatus',
        'mvrReviewDate', 'employmentVerificationStatus', 'overallStatus'
      ]
    },
    {
      name: 'Vehicle Inspection Summary',
      description: 'Annual inspection dates and compliance status',
      reportType: 'vehicle',
      isSystemTemplate: true,
      selectedFields: [
        'unitNumber', 'vin', 'make', 'year', 'annualInspectionDate',
        'annualInspectionExpiry', 'overallStatus'
      ]
    },
    {
      name: 'Violations Summary',
      description: 'BASIC categories, severity, and DataQ status',
      reportType: 'violations',
      isSystemTemplate: true,
      selectedFields: [
        'inspectionNumber', 'violationDate', 'violationType', 'violationCode',
        'basic', 'severityWeight', 'driverName', 'dataQStatus'
      ]
    }
  ];
};

module.exports = mongoose.model('ReportTemplate', reportTemplateSchema);
```

Create backend/config/reportFieldDefinitions.js with field metadata for all 9 report types. Each field has: key, label, default (boolean), type (string/date/number/boolean). Define fields based on existing report endpoints' output. Include helper functions getDefaultFields(reportType) and validateFields(reportType, fields).

The 9 report types are: dqf, vehicle, violations, audit, document-expiration, drug-alcohol, dataq-history, accident-summary, maintenance-costs.

For dqf fields include: driverName, employeeId, cdlNumber, cdlState, cdlClass, cdlExpiry, medicalExpiry, overallStatus, clearinghouseQueryDate, clearinghouseStatus, mvrReviewDate, mvrApproved, employmentVerificationStatus, roadTestDate, roadTestResult.

For vehicle fields include: unitNumber, vin, make, model, year, type, status, annualInspectionDate, annualInspectionExpiry, lastMaintenanceDate, mileage, overallStatus.

For violations fields include: inspectionNumber, violationDate, violationType, violationCode, description, basic, severityWeight, driverName, vehicleUnit, status, dataQStatus, dataQCaseNumber.

For audit fields include: section, metric, value (audit report is summary-level).

For document-expiration fields include: documentType, entityName, entityType, expirationDate, daysUntilExpiry, urgency.

For drug-alcohol fields include: driverName, testType, testDate, result, randomPoolIncluded, clearinghouseStatus.

For dataq-history fields include: caseNumber, submittedDate, violationCode, basic, originalSeverity, status, resolvedDate, outcome, pointsSaved.

For accident-summary fields include: accidentDate, driverName, vehicleUnit, location, dotReportable, injuries, fatalities, hazmatRelease, estimatedCost, status.

For maintenance-costs fields include: workOrderNumber, vehicleUnit, serviceDate, category, vendor, description, laborCost, partsCost, totalCost.
  </action>
  <verify>
    - `node -e "require('./backend/models/ReportTemplate')"` loads without error
    - `node -e "const d = require('./backend/config/reportFieldDefinitions'); console.log(Object.keys(d.REPORT_FIELD_DEFINITIONS).length)"` outputs 9
    - `node -e "const d = require('./backend/config/reportFieldDefinitions'); console.log(d.getDefaultFields('dqf').length > 0)"` outputs true
  </verify>
  <done>ReportTemplate model exports successfully, field definitions cover all 9 report types with helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Create reportTemplates routes with CRUD operations</name>
  <files>
    backend/routes/reportTemplates.js
    backend/routes/index.js
  </files>
  <action>
Create backend/routes/reportTemplates.js with standard CRUD routes:

1. GET / - List templates for company (include system templates + user templates)
   - Query params: reportType (optional filter)
   - Return both isSystemTemplate=true (global) and company-scoped templates
   - Sort by isSystemTemplate desc, then name asc

2. GET /:id - Get single template by ID
   - Validate company ownership OR isSystemTemplate=true

3. POST / - Create new template
   - Required: name, reportType, selectedFields
   - Optional: description, filters
   - Validate selectedFields against field definitions
   - Set createdBy from req.user
   - isSystemTemplate always false for user-created

4. PUT /:id - Update template
   - Block updates if isSystemTemplate=true (return 403)
   - Validate company ownership
   - Validate selectedFields if provided

5. DELETE /:id - Delete template
   - Block deletes if isSystemTemplate=true (return 403)
   - Validate company ownership

6. POST /:id/duplicate - Duplicate a template (including system templates)
   - Creates new user-owned copy with "(Copy)" appended to name
   - Sets isSystemTemplate=false on copy
   - Sets companyId to user's company

Use middleware: protect, restrictToCompany, checkPermission('reports', 'view') for read operations, checkPermission('reports', 'edit') for write operations.

Import and use validateFields from reportFieldDefinitions.js for field validation.

Use asyncHandler wrapper and AppError for errors following existing route patterns.

Register routes in backend/routes/index.js:
```javascript
const reportTemplateRoutes = require('./reportTemplates');
// Add with other route registrations
router.use('/report-templates', reportTemplateRoutes);
```
  </action>
  <verify>
    - backend/routes/reportTemplates.js file exists with GET, POST, PUT, DELETE, duplicate routes
    - `grep "report-templates" backend/routes/index.js` shows route registration
    - `cd backend && npm test -- --testPathPattern=reportTemplate` passes (if tests exist) OR manual verification: start backend, check route responds to GET /api/report-templates
  </verify>
  <done>ReportTemplates routes registered at /api/report-templates with full CRUD + duplicate, system templates protected from edit/delete</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Backend starts without errors: `cd backend && npm run dev` (check no startup errors)
2. ReportTemplate model loads: `node -e "require('./backend/models/ReportTemplate')"`
3. Field definitions complete: `node -e "const d = require('./backend/config/reportFieldDefinitions'); console.log(Object.keys(d.REPORT_FIELD_DEFINITIONS))"`
4. Routes registered: `grep -r "report-templates" backend/routes/`
</verification>

<success_criteria>
- ReportTemplate model created with selectedFields array and isSystemTemplate flag
- Field definitions exist for all 9 report types with getDefaultFields and validateFields helpers
- CRUD routes at /api/report-templates with system template protection
- Routes registered in index.js
</success_criteria>

<output>
After completion, create `.planning/phases/11-report-builder/11-01-SUMMARY.md`
</output>
