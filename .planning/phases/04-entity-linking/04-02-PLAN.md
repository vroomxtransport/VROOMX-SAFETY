---
phase: 04-entity-linking
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/models/Company.js
  - backend/services/fmcsaSyncOrchestrator.js
autonomous: true

must_haves:
  truths:
    - "Entity linking runs automatically after each sync completes"
    - "Linking results are logged with counts (linked, reviewRequired, skipped)"
    - "Linking failures do not crash the sync"
    - "Company.syncStatus tracks when linking last ran"
  artifacts:
    - path: "backend/services/fmcsaSyncOrchestrator.js"
      provides: "Orchestrator calls entityLinkingService after sync"
      contains: "entityLinkingService.linkViolationsForCompany"
    - path: "backend/models/Company.js"
      provides: "syncStatus.linkingLastRun timestamp"
      contains: "linkingLastRun"
  key_links:
    - from: "backend/services/fmcsaSyncOrchestrator.js"
      to: "backend/services/entityLinkingService.js"
      via: "require and call linkViolationsForCompany"
      pattern: "entityLinkingService\\.linkViolationsForCompany"
---

<objective>
Integrate the entity linking service into the sync orchestrator so linking runs automatically after each FMCSA sync.

Purpose: Entity linking should be seamless - when violations are synced, they're automatically linked to drivers and vehicles without manual intervention. This plan wires the linking service into the existing sync flow.

Output: Modified fmcsaSyncOrchestrator.js that calls entity linking as step 4, and Company model extended with linkingLastRun timestamp.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-entity-linking/04-01-PLAN.md

# Files to modify
@backend/services/fmcsaSyncOrchestrator.js
@backend/models/Company.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add linkingLastRun to Company.syncStatus schema</name>
  <files>backend/models/Company.js</files>
  <action>
Extend the Company model's fmcsaData.syncStatus schema to track entity linking.

Find the syncStatus schema definition (inside fmcsaData) and add:

```javascript
linkingLastRun: Date
```

This should be added alongside the existing fields:
- lastRun
- success
- errors
- csaScoresLastSync
- violationsLastSync
- inspectionsLastSync

The new field tracks when entity linking last completed for this company.

**Important:** Do NOT change any other parts of the Company model. Only add this one field.
  </action>
  <verify>Run `grep -A 2 "linkingLastRun" backend/models/Company.js` - should show the field definition</verify>
  <done>Company.fmcsaData.syncStatus.linkingLastRun field exists as Date type</done>
</task>

<task type="auto">
  <name>Task 2: Add entity linking step to sync orchestrator</name>
  <files>backend/services/fmcsaSyncOrchestrator.js</files>
  <action>
Modify fmcsaSyncOrchestrator.js to call entity linking as step 4 after the existing sync steps.

**Add require at top:**
```javascript
const entityLinkingService = require('./entityLinkingService');
```

**In syncCompany method, after step 3 (inspection stats), add step 4:**

```javascript
// 4. Link violations to entities (drivers/vehicles)
try {
  console.log(`[FMCSA Orchestrator] Running entity linking for company ${companyId}`);
  const linkingResult = await entityLinkingService.linkViolationsForCompany(companyId);
  timestamps.linkingLastRun = new Date();
  console.log(`[FMCSA Orchestrator] Linking complete: ${linkingResult.linked} linked, ${linkingResult.reviewRequired} need review, ${linkingResult.skipped} skipped`);
} catch (err) {
  console.error(`[FMCSA Orchestrator] Entity linking failed:`, err.message);
  errors.push({ source: 'entity_linking', error: err.message, timestamp: new Date() });
}
```

**Update the Company.updateOne call to include linkingLastRun:**
Add to the $set object:
```javascript
...(timestamps.linkingLastRun && { 'fmcsaData.syncStatus.linkingLastRun': timestamps.linkingLastRun })
```

**Pattern to follow:**
The existing code has exactly this pattern for csaScoresLastSync, violationsLastSync, inspectionsLastSync.
Follow the same per-source try/catch pattern that ensures one failure doesn't stop others.

**Important:**
- Entity linking should run AFTER violations sync (step 2) because it needs violations to exist
- Linking errors should NOT mark the entire sync as failed - add to errors array but don't change success logic
- Use the same error object structure: { source: 'entity_linking', error: message, timestamp: new Date() }
  </action>
  <verify>
1. Require exists: `grep "entityLinkingService" backend/services/fmcsaSyncOrchestrator.js | head -3`
2. Step 4 exists: `grep -A 3 "Running entity linking" backend/services/fmcsaSyncOrchestrator.js`
3. Timestamp saved: `grep "linkingLastRun" backend/services/fmcsaSyncOrchestrator.js`
  </verify>
  <done>
- entityLinkingService required at top of fmcsaSyncOrchestrator.js
- Step 4 calls entityLinkingService.linkViolationsForCompany(companyId)
- Linking results logged with linked/reviewRequired/skipped counts
- linkingLastRun timestamp saved to Company.fmcsaData.syncStatus
- Errors added to errors array (does not crash sync)
  </done>
</task>

</tasks>

<verification>
1. Company schema has new field: `grep "linkingLastRun" backend/models/Company.js`
2. Orchestrator requires service: `grep "require.*entityLinkingService" backend/services/fmcsaSyncOrchestrator.js`
3. Orchestrator calls linking: `grep "linkViolationsForCompany" backend/services/fmcsaSyncOrchestrator.js`
4. Timestamp persisted: `grep "linkingLastRun.*timestamps" backend/services/fmcsaSyncOrchestrator.js`
</verification>

<success_criteria>
- [ ] Company.fmcsaData.syncStatus.linkingLastRun added as Date field
- [ ] entityLinkingService required in fmcsaSyncOrchestrator.js
- [ ] Step 4 added after inspection stats sync
- [ ] Linking results logged with linked/reviewRequired/skipped counts
- [ ] linkingLastRun timestamp saved to Company document
- [ ] Entity linking errors do not fail the overall sync
- [ ] Error object uses source: 'entity_linking'
</success_criteria>

<output>
After completion, create `.planning/phases/04-entity-linking/04-02-SUMMARY.md`
</output>
